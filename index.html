<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="静谧星空的博客">
<meta property="og:url" content="https://blog.msrily.com/index.html">
<meta property="og:site_name" content="静谧星空的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="静谧星空的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.msrily.com/"/>





  <title>静谧星空的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">静谧星空的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/05/24/blog13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/24/blog13/" itemprop="url">GCD 队列探索</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-24T18:44:25+08:00">
                2018-05-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>同步串行队列、异步串行队列和同步并行队列都只创建一个线程，而异步并行队列则创建多个线程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_t queue1 = dispatch_queue_create(&quot;com.demo.1&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    for (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">//        dispatch_sync(queue1, ^&#123;</span><br><span class="line">//            NSLog(@&quot;%p&quot;, [NSThread currentThread]);</span><br><span class="line">//        &#125;);</span><br><span class="line">        /*</span><br><span class="line">         2018-09-17 18:38:38.654309+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.654448+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.654543+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.654643+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.654729+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.654879+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.654974+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.655165+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.655250+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         2018-09-17 18:38:38.655363+0800 testUI[31197:422120] 0x60400006ac80</span><br><span class="line">         */</span><br><span class="line">//        dispatch_async(queue1, ^&#123;</span><br><span class="line">//            NSLog(@&quot;%p&quot;, [NSThread currentThread]);</span><br><span class="line">//        &#125;);</span><br><span class="line">        /*</span><br><span class="line">         2018-09-17 18:40:02.443306+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.443462+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.443560+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.443660+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.443830+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.444017+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.444403+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.444509+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.444737+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         2018-09-17 18:40:02.445109+0800 testUI[31225:423440] 0x604000269740</span><br><span class="line">         */</span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_queue_t queue2 = dispatch_queue_create(&quot;com.demo.2&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    for (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">//        dispatch_sync(queue2, ^&#123;</span><br><span class="line">//            NSLog(@&quot;%p&quot;, [NSThread currentThread]);</span><br><span class="line">//        &#125;);</span><br><span class="line">        /*</span><br><span class="line">         2018-09-17 18:41:26.184301+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.184430+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.184519+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.184612+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.184721+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.184807+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.184906+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.185005+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.185111+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         2018-09-17 18:41:26.185218+0800 testUI[31260:424690] 0x600000063540</span><br><span class="line">         */</span><br><span class="line">        dispatch_async(queue2, ^&#123;</span><br><span class="line">            NSLog(@&quot;%p&quot;, [NSThread currentThread]);</span><br><span class="line">        &#125;);</span><br><span class="line">        /*</span><br><span class="line">         2018-09-17 18:43:35.575104+0800 testUI[31313:426896] 0x604000469f40</span><br><span class="line">         2018-09-17 18:43:35.575104+0800 testUI[31313:426894] 0x600000271cc0</span><br><span class="line">         2018-09-17 18:43:35.575104+0800 testUI[31313:426895] 0x600000271bc0</span><br><span class="line">         2018-09-17 18:43:35.575126+0800 testUI[31313:426893] 0x600000272480</span><br><span class="line">         2018-09-17 18:43:35.575260+0800 testUI[31313:426894] 0x600000271cc0</span><br><span class="line">         2018-09-17 18:43:35.575270+0800 testUI[31313:426896] 0x604000469f40</span><br><span class="line">         2018-09-17 18:43:35.575304+0800 testUI[31313:426895] 0x600000271bc0</span><br><span class="line">         2018-09-17 18:43:35.575359+0800 testUI[31313:426893] 0x600000272480</span><br><span class="line">         2018-09-17 18:43:35.575386+0800 testUI[31313:426897] 0x600000271c40</span><br><span class="line">         2018-09-17 18:43:35.575394+0800 testUI[31313:426894] 0x600000271cc0</span><br><span class="line">         */</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>最后一个结果有点意思，事实上没有创建10个线程，推测应该是此时GCD实现线程池的能力，以减少创建线程的开销，提高性能。</p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/05/23/blog12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/23/blog12/" itemprop="url">Objective C 类crash预防</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-23T16:29:23+08:00">
                2018-05-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Persion类</p>
<p><img src="/images/16a7155c-f0ff-47e9-bdca-47f517b30d1d.png" alt=""></p>
<p><img src="/images/0235ad78-fb93-420a-9acf-b7f7076dfd46.png" alt=""></p>
<p><img src="/images/93af98b9-0108-4069-a18b-579723fb30e7.png" alt=""></p>
<p>运行结果：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-09-17 18:07:47.368888+0800 demo11[30894:402677] 20</span><br><span class="line">2018-09-17 18:07:47.369026+0800 demo11[30894:402677] ---eat----</span><br><span class="line">2018-09-17 18:07:47.369233+0800 demo11[30894:402677] ---crash----</span><br></pre></td></tr></table></figure></p>
<p>第三副图调用objc_msgSend方法直接绕过了这个预防机制。</p>
<p>使用<code>[persion setValue:@(4) forKey:@&quot;_count&quot;];</code>可以给存在的属性赋值<b>（无论其属性是否可读或隐藏）</b>，走的消息转发。</p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/05/17/blog11/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/17/blog11/" itemprop="url">iOS App启动过程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-17T13:57:39+08:00">
                2018-05-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Mach-O"><a href="#Mach-O" class="headerlink" title="Mach-O"></a>Mach-O</h2><p><img src="/images/299fcf31-8662-4634-af54-b6b0ca50ab2d.png" alt=""></p>
<ul>
<li>Header 头部，包含可以执行的CPU架构，比如x86,x86_64,arm7s,arm64</li>
<li>Load commands 加载命令，包含文件的组织架构和在虚拟内存中的布局方式</li>
<li>Data，数据，包含load commands中需要的各个段(segment)的数据，每一个Segment都得大小是Page的整数倍。<br>  1) <strong>TEXT 代码段，只读（通常使用于frameworks,bundles,shared libraries）<br>  2) </strong>DATA 数据段，读写<br>  3) <strong>OBJC OC动态语言支持相关的数据<br>  4) </strong>IMPORT 仅IA-32平台生成<br>  5) __LINKEDIT 动态链接器使用的元数据（符号、字符串、入口）</li>
</ul>
<h2 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a>dyld</h2><p>dyld的全称是<a href="https://developer.apple.com/library/archive/releasenotes/DeveloperTools/RN-dyld/" target="_blank" rel="noopener">dynamic loader</a>，它的作用是加载一个进程所需要的image，dyld是<a href="https://opensource.apple.com/source/dyld/dyld-421.2/" target="_blank" rel="noopener">开源的</a>。</p>
<h2 id="启动过程"><a href="#启动过程" class="headerlink" title="启动过程"></a>启动过程</h2><ol>
<li>加载dyld到App进程</li>
<li>加载动态库（包括所依赖的所有动态库）</li>
<li>Rebase </li>
<li>Bind </li>
<li>初始化Objective C Runtime </li>
<li>其它的初始化代码</li>
</ol>
<h3 id="加载动态库"><a href="#加载动态库" class="headerlink" title="加载动态库"></a>加载动态库</h3><p>dyld会首先读取mach-o文件的Header和load commands。<br>接着就知道了这个可执行文件依赖的动态库。例如加载动态库A到内存，接着检查A所依赖的动态库，就这样的递归加载，直到所有的动态库加载完毕。通常一个App所依赖的动态库在100-400个左右，其中大多数都是系统的动态库，它们会被缓存到dyld shared cache，这样读取的效率会很高。</p>
<p>查看mach-o文件所依赖的动态库，可以通过MachOView的图形化界面(展开Load Command就能看到)，也可以通过命令行otool。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -L demo</span><br></pre></td></tr></table></figure>
<h3 id="Rebase-amp-amp-Bind"><a href="#Rebase-amp-amp-Bind" class="headerlink" title="Rebase &amp;&amp; Bind"></a>Rebase &amp;&amp; Bind</h3><p>有两种主要的技术来保证应用的安全：ASLR和Code Sign。</p>
<p>ASLR的全称是Address space layout randomization，翻译过来就是“地址空间布局随机化”。App被启动的时候，程序会被映射到逻辑的地址空间，这个逻辑的地址空间有一个起始地址，而ASLR技术使得这个起始地址是随机的。如果是固定的，那么黑客很容易就可以由起始地址+偏移量找到函数的地址。</p>
<p>Code Sign相信大多数开发者都知晓，这里要提一点的是，在进行Code sign的时候，加密哈希不是针对于整个文件，而是针对于每一个Page的。这就保证了在dyld进行加载的时候，可以对每一个page进行独立的验证。</p>
<p>mach-o中有很多符号，有指向当前mach-o的，也有指向其他dylib的，比如printf。那么，在运行时，代码如何准确的找到printf的地址呢？</p>
<p>mach-o中采用了PIC技术，全称是Position Independ code。当你的程序要调用printf的时候，会先在__DATA段中建立一个指针指向printf，在通过这个指针实现间接调用。dyld这时候需要做一些fix-up工作，即帮助应用程序找到这些符号的实际地址。主要包括两部分:</p>
<ul>
<li>Rebase 修正内部(指向当前mach-o文件)的指针指向</li>
<li>Bind 修正外部指针指向</li>
</ul>
<p><img src="/images/20171023100523145.png" alt=""></p>
<p>之所以需要Rebase，是因为刚刚提到的ASLR使得地址随机化，导致起始地址不固定，另外由于Code Sign，导致不能直接修改Image。Rebase的时候只需要增加对应的偏移量即可。待Rebase的数据都存放在__LINKEDIT中。<br>可以通过MachOView查看：Dynamic Loader Info -&gt; Rebase Info</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun dyldinfo -<span class="built_in">bind</span> demo</span><br></pre></td></tr></table></figure>
<p>Rebase解决了内部的符号引用问题，而外部的符号引用则是由Bind解决。在解决Bind的时候，是根据字符串匹配的方式查找符号表，所以这个过程相对于Rebase来说是略慢的。</p>
<h3 id="初始化Objective-C-Runtime"><a href="#初始化Objective-C-Runtime" class="headerlink" title="初始化Objective C Runtime"></a>初始化Objective C Runtime</h3><p>Objective C是动态语言，所以在执行main函数之前，需要把类的信息注册到一个全局的Table中。同时，Objective C支持Category，在初始化的时候，也会把Category中的方法注册到对应的类中，同时会唯一Selector，这也是为什么当你的Cagegory实现了类中同名的方法后，类中的方法会被覆盖。</p>
<p>另外，由于iOS开发时基于Cocoa Touch的，所以绝大多数的类起始都是系统类，所以大多数的Runtime初始化起始在Rebase和Bind中已经完成。</p>
<h3 id="Initializers"><a href="#Initializers" class="headerlink" title="Initializers"></a>Initializers</h3><p>主要包括几部分：</p>
<ul>
<li>+load方法。</li>
<li>C／C++静态初始化对象和标记为<strong>attribute</strong>(constructor)的方法</li>
</ul>
<h4 id="注：-load方法已经被弃用了，如果你用Swift开发，你会发现根本无法去写这样一个方法，官方的建议是实用initialize。区别就是，load是在类装载的时候执行，而initialize是在类第一次收到message前调用。"><a href="#注：-load方法已经被弃用了，如果你用Swift开发，你会发现根本无法去写这样一个方法，官方的建议是实用initialize。区别就是，load是在类装载的时候执行，而initialize是在类第一次收到message前调用。" class="headerlink" title="注：+load方法已经被弃用了，如果你用Swift开发，你会发现根本无法去写这样一个方法，官方的建议是实用initialize。区别就是，load是在类装载的时候执行，而initialize是在类第一次收到message前调用。"></a>注：+load方法已经被弃用了，如果你用Swift开发，你会发现根本无法去写这样一个方法，官方的建议是实用initialize。区别就是，load是在类装载的时候执行，而initialize是在类第一次收到message前调用。</h4><h3 id="上文的讲解是dyld2的加载方式。而最新的是dyld3加载方式略有不同："><a href="#上文的讲解是dyld2的加载方式。而最新的是dyld3加载方式略有不同：" class="headerlink" title="上文的讲解是dyld2的加载方式。而最新的是dyld3加载方式略有不同："></a>上文的讲解是dyld2的加载方式。而最新的是dyld3加载方式略有不同：</h3><p><img src="/images/20171022203521690.png" alt=""></p>
<p>dyld2是纯粹的in-process，也就是在程序进程内执行的，也就意味着只有当应用程序被启动的时候，dyld2才能开始执行任务。</p>
<p>dyld3则是部分out-of-process，部分in-process。图中，虚线之上的部分是out-of-process的，在App下载安装和版本更新的时候会去执行，out-of-process会做如下事情：</p>
<ul>
<li>分析Mach-o Headers</li>
<li>分析依赖的动态库</li>
<li>查找需要Rebase &amp; Bind之类的符号</li>
<li>把上述结果写入缓存</li>
</ul>
<p>这样，在应用启动的时候，就可以直接从缓存中读取数据，加快加载速度。</p>
<p>启动时间在小于400ms是最佳的，因为从点击图标到显示Launch Screen，到Launch Screen消失这段时间是400ms。启动时间不可以大于20s，否则会被系统杀掉。</p>
<p>在Xcode中，可以通过设置环境变量来查看App的启动时间，DYLD_PRINT_STATISTICS和DYLD_PRINT_STATISTICS_DETAILS。</p>
<h3 id="优化启动时间"><a href="#优化启动时间" class="headerlink" title="优化启动时间"></a>优化启动时间</h3><h4 id="dylibs"><a href="#dylibs" class="headerlink" title="dylibs"></a>dylibs</h4><p>启动的第一步是加载动态库，加载系统的动态库使很快的，因为可以缓存，而加载内嵌的动态库速度较慢。所以，提高这一步的效率的关键是：减少动态库的数量。</p>
<p>合并动态库.比如公司内部由私有Pod建立了如下动态库：XXTableView, XXHUD, XXLabel，强烈建议合并成一个XXUIKit来提高加载速度。</p>
<h4 id="Rebase-amp-Bind-amp-Objective-C-Runtime"><a href="#Rebase-amp-Bind-amp-Objective-C-Runtime" class="headerlink" title="Rebase &amp; Bind &amp; Objective C Runtime"></a>Rebase &amp; Bind &amp; Objective C Runtime</h4><p>Rebase和Bind都是为了解决指针引用的问题。对于Objective C开发来说，主要的时间消耗在Class/Method的符号加载上，所以常见的优化方案是：</p>
<ul>
<li>减少__DATA段中的指针数量。</li>
<li>合并Category和功能类似的类。比如：UIView+Frame,UIView+AutoLayout…合并为一个删除无用的方法和类。</li>
<li>多用Swift Structs，因为Swfit Structs是静态分发的。</li>
</ul>
<h4 id="Initializers-1"><a href="#Initializers-1" class="headerlink" title="Initializers"></a>Initializers</h4><p>通常，我们会在+load方法中进行method-swizzling。</p>
<ul>
<li>用initialize替代load。不少同学喜欢用method-swizzling来实现AOP去做日志统计等内容，强烈建议改为在initialize进行初始化。</li>
<li>减少<strong>atribute</strong>((constructor))的使用，而是在第一次访问的时候才用dispatch_once等方式初始化。</li>
<li>不要创建线程</li>
<li>使用Swfit重写代码。</li>
</ul>
<p>转自：<a href="https://blog.csdn.net/Hello_Hwc/article/details/78317863?locationNum=9&amp;fps=1" target="_blank" rel="noopener">深入理解iOS App的启动过程</a></p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/05/09/blog10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/09/blog10/" itemprop="url">iOS SnapKit源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-09T15:50:02+08:00">
                2018-05-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>iOS布局从Frame到Autosizing，再到Autolayout。Storyboard上使用Autolayout对于层级不深的页面来说比较方便，大大提升了开发速度，但App体积也会增加不少，用代码写Autolayout就不是那么方便了。如</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// view1已经使用Autolayout布好局了</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> view0 = <span class="type">UIView</span>()</span><br><span class="line">view0.backgroundColor = <span class="type">UIColor</span>.gray</span><br><span class="line">view0.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line"><span class="keyword">self</span>.view.addSubview(view0)</span><br><span class="line"><span class="keyword">let</span> leftConstraint = <span class="type">NSLayoutConstraint</span>(item: view0, attribute: <span class="type">NSLayoutAttribute</span>.<span class="keyword">left</span>, relatedBy: <span class="type">NSLayoutRelation</span>.<span class="built_in">equal</span>, toItem: view1, attribute: <span class="type">NSLayoutAttribute</span>.<span class="keyword">left</span>, multiplier: <span class="number">1</span>, constant: <span class="number">100</span>)</span><br><span class="line"><span class="keyword">let</span> topConstraint = <span class="type">NSLayoutConstraint</span>(item: view0, attribute: <span class="type">NSLayoutAttribute</span>.top, relatedBy: <span class="type">NSLayoutRelation</span>.<span class="built_in">equal</span>, toItem: <span class="keyword">self</span>.view, attribute: <span class="type">NSLayoutAttribute</span>.top, multiplier: <span class="number">1</span>, constant: <span class="number">20</span>)</span><br><span class="line"><span class="keyword">let</span> widthConstraint = <span class="type">NSLayoutConstraint</span>(item: view0, attribute: <span class="type">NSLayoutAttribute</span>.width, relatedBy: <span class="type">NSLayoutRelation</span>.<span class="built_in">equal</span>, toItem: <span class="keyword">self</span>.view, attribute: <span class="type">NSLayoutAttribute</span>.width, multiplier: <span class="number">0.5</span>, constant: <span class="number">0</span>)</span><br><span class="line"><span class="keyword">let</span> heightConstraint = <span class="type">NSLayoutConstraint</span>(item: view0, attribute: <span class="type">NSLayoutAttribute</span>.height, relatedBy: <span class="type">NSLayoutRelation</span>.<span class="built_in">equal</span>, toItem: view0, attribute: <span class="type">NSLayoutAttribute</span>.width, multiplier: <span class="number">1</span>, constant: <span class="number">0</span>)</span><br><span class="line"><span class="keyword">let</span> constraints = [leftConstraint, topConstraint, widthConstraint, heightConstraint]</span><br><span class="line"><span class="type">NSLayoutConstraint</span>.activate(constraints)</span><br></pre></td></tr></table></figure>
<p>布好一个控件就要写很长串，还怕写错，比较麻烦。<br><br>SnapKit是对Autolayout的封装，是Objective-C Masonry的同一个团体Swift版本。</p>
<p>使用Swift先进语法以及拟多态的方法极大地简化了代码写Autolayout约束，如：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> view1 = <span class="type">UIView</span>()</span><br><span class="line">view1.backgroundColor = <span class="type">UIColor</span>.red</span><br><span class="line"><span class="keyword">self</span>.view.addSubview(view1)</span><br><span class="line">view1.snp.makeConstraints &#123; (make) <span class="keyword">in</span></span><br><span class="line">    make.<span class="keyword">left</span>.top.<span class="keyword">right</span>.bottom.equalTo(<span class="number">0</span>).offset(<span class="number">0</span>).multipliedBy(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>阅读起来很简单且使用方便</p>
<p>声明ConstraintConstantTarget(ConstraintOffsetTarget、ConstraintInsetTarget)，然后通过extension对一些已经存在的或者自定义的类型通过NSLayoutAttribute来转换成NSLayoutConstraint的constant，ConstraintMultiplierTarget通过extension来改变NSLayoutConstraint的multiplier,ConstraintPriorityTarget通过extension来改变NSLayoutConstraint的priority等。</p>
<p><img src="/images/1525858507.png" alt=""></p>
<p>这种编程方法值得学习。</p>
<p>声明ConstraintAttributes，将所有的属性都定义下来</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> <span class="keyword">none</span>: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">0</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> <span class="keyword">left</span>: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">1</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> top: <span class="type">ConstraintAttributes</span> &#123;  <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">2</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> <span class="keyword">right</span>: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">4</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> bottom: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">8</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> leading: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">16</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> trailing: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">32</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> width: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">64</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> height: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">128</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> centerX: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">256</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> centerY: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">512</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> lastBaseline: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">1024</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, <span class="type">OSX</span> <span class="number">10.11</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> firstBaseline: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">2048</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> leftMargin: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">4096</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> rightMargin: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">8192</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> topMargin: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">16384</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> bottomMargin: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">32768</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> leadingMargin: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">65536</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> trailingMargin: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">131072</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> centerXWithinMargins: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">262144</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> centerYWithinMargins: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">524288</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// aggregates</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> edges: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">15</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> size: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">192</span>) &#125;</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> center: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">768</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> margins: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">61440</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@available</span>(iOS <span class="number">8.0</span>, *)</span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">var</span> centerWithinMargins: <span class="type">ConstraintAttributes</span> &#123; <span class="keyword">return</span> <span class="keyword">self</span>.<span class="keyword">init</span>(<span class="number">786432</span>) &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到每个属性都是2的n次方<br><br>通过<figure class="highlight plain"><figcaption><span>layoutAttributes:[LayoutAttribute] ```来获取NSLayoutAttribute集合，这里用到Swift OptionSet类的union、formUnion、subtract和contains语法</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ConstraintView的extensions中snp变量返回ConstraintViewDSL对象,ConstraintLayoutGuideDSL是它的子类，提供prepareConstraints、makeConstraints、remakeConstraints、updateConstraints、removeConstraints等方法。&lt;br/&gt;</span><br><span class="line">可以看到这些方法都是通过使用工厂类ConstraintMaker来管理约束的。</span><br><span class="line"></span><br><span class="line">```Swift</span><br><span class="line">    internal static func makeConstraints(item: LayoutConstraintItem, closure: (_ make: ConstraintMaker) -&gt; Void) &#123;</span><br><span class="line">        let maker = ConstraintMaker(item: item)</span><br><span class="line">        closure(maker)</span><br><span class="line">        var constraints: [Constraint] = []</span><br><span class="line">        for description in maker.descriptions &#123;</span><br><span class="line">            guard let constraint = description.constraint else &#123;</span><br><span class="line">                continue</span><br><span class="line">            &#125;</span><br><span class="line">            constraints.append(constraint)</span><br><span class="line">        &#125;</span><br><span class="line">        for constraint in constraints &#123;</span><br><span class="line">            constraint.activateIfNeeded(updatingExisting: false)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>ConstraintMaker的init方法：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">init</span>(item: <span class="type">LayoutConstraintItem</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.item = item</span><br><span class="line">    <span class="keyword">self</span>.item.prepare()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以left为例(同以上举例<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```Swift</span><br><span class="line">    public var left: ConstraintMakerExtendable &#123;</span><br><span class="line">        return self.makeExtendableWithAttributes(.left)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    internal func makeExtendableWithAttributes(_ attributes: ConstraintAttributes) -&gt; ConstraintMakerExtendable &#123;</span><br><span class="line">        let description = ConstraintDescription(item: self.item, attributes: attributes)</span><br><span class="line">        self.descriptions.append(description)</span><br><span class="line">        return ConstraintMakerExtendable(description)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>ConstraintDescription是对NSLayoutConstraint的描述，生成Constraint对象，Constraint对象最终生成约束。</p>
<p>而之所以可以连着调用top、right、bottom得益于ConstraintMakerExtendable类：<figure class="highlight plain"><figcaption><span>self.makeExtendableWithAttributes(.left)```得到ConstraintMakerExtendable类，后面top</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">```Swift</span><br><span class="line">    //ConstraintMakerExtendable</span><br><span class="line">    public var top: ConstraintMakerExtendable &#123;</span><br><span class="line">        self.description.attributes += .top</span><br><span class="line">        return self</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //ConstraintAttributes</span><br><span class="line">    internal func +=(left: inout ConstraintAttributes, right: ConstraintAttributes) &#123;</span><br><span class="line">        left.formUnion(right)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //ConstraintMakerExtendable</span><br><span class="line">    public func equalTo(_ other: ConstraintRelatableTarget, _ file: String = #file, _ line: UInt = #line) -&gt; ConstraintMakerEditable &#123;</span><br><span class="line">        return self.relatedTo(other, relation: .equal, file: file, line: line)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    internal func relatedTo(_ other: ConstraintRelatableTarget, relation: ConstraintRelation, file: String, line: UInt) -&gt; ConstraintMakerEditable &#123;</span><br><span class="line">        let related: ConstraintItem</span><br><span class="line">        let constant: ConstraintConstantTarget</span><br><span class="line">        </span><br><span class="line">        if let other = other as? ConstraintItem &#123;</span><br><span class="line">            guard other.attributes == ConstraintAttributes.none ||</span><br><span class="line">                  other.attributes.layoutAttributes.count &lt;= 1 ||</span><br><span class="line">                  other.attributes.layoutAttributes == self.description.attributes.layoutAttributes ||</span><br><span class="line">                  other.attributes == .edges &amp;&amp; self.description.attributes == .margins ||</span><br><span class="line">                  other.attributes == .margins &amp;&amp; self.description.attributes == .edges else &#123;</span><br><span class="line">                fatalError(&quot;Cannot constraint to multiple non identical attributes. (\(file), \(line))&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            related = other</span><br><span class="line">            constant = 0.0</span><br><span class="line">        &#125; else if let other = other as? ConstraintView &#123;</span><br><span class="line">            related = ConstraintItem(target: other, attributes: ConstraintAttributes.none)</span><br><span class="line">            constant = 0.0</span><br><span class="line">        &#125; else if let other = other as? ConstraintConstantTarget &#123;</span><br><span class="line">            related = ConstraintItem(target: nil, attributes: ConstraintAttributes.none)</span><br><span class="line">            constant = other</span><br><span class="line">        &#125; else if #available(iOS 9.0, OSX 10.11, *), let other = other as? ConstraintLayoutGuide &#123;</span><br><span class="line">            related = ConstraintItem(target: other, attributes: ConstraintAttributes.none)</span><br><span class="line">            constant = 0.0</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            fatalError(&quot;Invalid constraint. (\(file), \(line))&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        let editable = ConstraintMakerEditable(self.description)</span><br><span class="line">        editable.description.sourceLocation = (file, line)</span><br><span class="line">        editable.description.relation = relation</span><br><span class="line">        editable.description.related = related</span><br><span class="line">        editable.description.constant = constant</span><br><span class="line">        return editable</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">item1.attribute1 = multiplier × item2.attribute2 + constant</span><br><span class="line"></span><br><span class="line"><span class="type">NSLayoutConstraint</span>(item: from, attribute: from属性, relatedBy: related关系, toItem: to, attribute: to属性, multiplier: multiplier, constant: constant)</span><br></pre></td></tr></table></figure>
<p>relatedTo这个方法生成related关系、“to”和“to”的属性和constant</p>
<p>接下来的offset和multipliedBy都是ConstraintMakerEditable类的实例方法</p>
<p><img src="/images/1525872713.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">```Swift</span><br><span class="line">    let layoutConstraint = LayoutConstraint(</span><br><span class="line">                item: layoutFrom,</span><br><span class="line">                attribute: layoutFromAttribute,</span><br><span class="line">                relatedBy: layoutRelation,</span><br><span class="line">                toItem: layoutTo,</span><br><span class="line">                attribute: layoutToAttribute,</span><br><span class="line">                multiplier: self.multiplier.constraintMultiplierTargetValue,</span><br><span class="line">                constant: layoutConstant</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>
<p>生成了NSLayoutConstraint对象了,在Constraint类的方法activateIfNeeded中我们也发现了<code>NSLayoutConstraint.activate(layoutConstraints)</code>方法了。</p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/04/13/blog9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/13/blog9/" itemprop="url">Today Extension和3D Touch</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-13T14:38:52+08:00">
                2018-04-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Today-Extension"><a href="#Today-Extension" class="headerlink" title="Today Extension"></a>Today Extension</h3><h5 id="1-点击文件，选择如下图"><a href="#1-点击文件，选择如下图" class="headerlink" title="1.点击文件，选择如下图"></a>1.点击文件，选择如下图<br></h5><p><img src="/images/1523602659.png" alt=""><br><br><br><img src="/images/1523603517.png" alt=""><br><br><br><img src="/images/1523603742.png" alt=""></p>
<h5 id="2-选择scheme为demo，run之后显示“hello-world”"><a href="#2-选择scheme为demo，run之后显示“hello-world”" class="headerlink" title="2.选择scheme为demo，run之后显示“hello world”"></a>2.选择scheme为demo，run之后显示“hello world”<br></h5><p>在MainInterface.storyboard里或在TodayViewController里的viewdidload方法里布局UI（跟app开发一样）<br></p>
<h5 id="3-当需要与主app共享数据时，需配置App-Group，具体如下图"><a href="#3-当需要与主app共享数据时，需配置App-Group，具体如下图" class="headerlink" title="3.当需要与主app共享数据时，需配置App Group，具体如下图"></a>3.当需要与主app共享数据时，需配置App Group，具体如下图<br></h5><p><img src="/images/1523604601.png" alt=""><br>注：App Group为空时，请点左下角的”+”<br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let userDefault = UserDefaults(suiteName: &quot;group.shine&quot;)!</span><br></pre></td></tr></table></figure></p>
<p>使用userDefault来存储需要共享的数据<br></p>
<h5 id="4-当extension需要调用主app的方法时通过URL方式"><a href="#4-当extension需要调用主app的方法时通过URL方式" class="headerlink" title="4.当extension需要调用主app的方法时通过URL方式"></a>4.当extension需要调用主app的方法时通过URL方式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">self.extensionContext?.open(URL(string: &quot;shineDemo://todayExtension?index=0&quot;)!, completionHandler: &#123; (res) in</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>
<p>主App配置URL的scheme<br><br><img src="/images/1523605177.png" alt=""></p>
<h3 id="3D-Touch"><a href="#3D-Touch" class="headerlink" title="3D Touch"></a>3D Touch</h3><p>上代码（动态3D Touch方式）<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">guard</span> <span class="keyword">let</span> filePath = <span class="type">Bundle</span>.main.url(forResource: <span class="string">"3dtouchdemo"</span>, withExtension: <span class="string">"json"</span>),</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">try</span>? <span class="type">Data</span>.<span class="keyword">init</span>(contentsOf: filePath),</span><br><span class="line">        <span class="keyword">let</span> json = (<span class="keyword">try</span>? <span class="type">JSONSerialization</span>.jsonObject(with: data, options: <span class="type">JSONSerialization</span>.<span class="type">ReadingOptions</span>.mutableContainers)) <span class="keyword">as</span>? [[<span class="type">String</span>: <span class="type">Any</span>]] <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">var</span> items = [<span class="type">UIApplicationShortcutItem</span>]()</span><br><span class="line"><span class="keyword">for</span> jsonItem <span class="keyword">in</span> json &#123;</span><br><span class="line">    <span class="keyword">let</span> icon = <span class="type">UIApplicationShortcutIcon</span>(type: shortcutIconWithType(jsonItem[<span class="string">"icon"</span>] <span class="keyword">as</span>! <span class="type">String</span>))</span><br><span class="line">    <span class="keyword">let</span> item = <span class="type">UIApplicationShortcutItem</span>(type: jsonItem[<span class="string">"icon"</span>] <span class="keyword">as</span>! <span class="type">String</span>, localizedTitle: jsonItem[<span class="string">"title"</span>] <span class="keyword">as</span>! <span class="type">String</span>, localizedSubtitle: (jsonItem[<span class="string">"subtitle"</span>] <span class="keyword">as</span>! <span class="type">String</span>), icon: icon, userInfo: jsonItem[<span class="string">"userInfo"</span>] <span class="keyword">as</span>? [<span class="type">AnyHashable</span> : <span class="type">Any</span>])</span><br><span class="line">    items.append(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">UIApplication</span>.shared.shortcutItems = items</span><br></pre></td></tr></table></figure></p>
<p>附：3dtouchdemo.json<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">    <span class="attr">"icon"</span>: <span class="string">"add"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"增加"</span>,</span><br><span class="line">    <span class="attr">"subtitle"</span>: <span class="string">"增加-add"</span>,</span><br><span class="line">    <span class="attr">"userInfo"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"add"</span></span><br><span class="line">    &#125;</span><br><span class="line"> &#125;,&#123;</span><br><span class="line">     <span class="attr">"icon"</span>: <span class="string">"alarm"</span>,</span><br><span class="line">     <span class="attr">"title"</span>: <span class="string">"闹钟"</span>,</span><br><span class="line">     <span class="attr">"subtitle"</span>: <span class="string">"闹钟-alarm"</span>,</span><br><span class="line">     <span class="attr">"userInfo"</span>: &#123;</span><br><span class="line">         <span class="attr">"type"</span>: <span class="string">"alarm"</span></span><br><span class="line">     &#125;</span><br><span class="line"> &#125;]</span><br></pre></td></tr></table></figure></p>
<p>在AppDelegate委托方法里实现点击后的事件处理，可以通过UIApplicationShortcutItem的type来判断不同的Item<br><br><img src="/images/1523605834.png" alt=""></p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/03/27/blog8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/blog8/" itemprop="url">iOS app进入后台毛玻璃效果</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T11:14:34+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>直接上代码（Swift）</p>
<pre>
    func applicationDidBecomeActive(_ application: UIApplication) {
        if let visualEffectView = self.visualEffectView {
            UIView.animate(withDuration: 0.5, animations: {
                visualEffectView.alpha = 0
            }, completion: { (_) in
                visualEffectView.removeFromSuperview()
            })
        }
    }

    weak var visualEffectView: UIVisualEffectView?
    func applicationWillResignActive(_ application: UIApplication) {
        let blurEffect = UIBlurEffect(style: UIBlurEffectStyle.light)
        let visualEffectView = UIVisualEffectView(effect: blurEffect)
        visualEffectView.alpha = 0
        visualEffectView.frame = self.window?.frame ?? CGRect.zero
        self.window?.addSubview(visualEffectView)
        self.visualEffectView = visualEffectView
        UIView.animate(withDuration: 0.5) {
            visualEffectView.alpha = 1
        }
    }
</pre>
          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/03/27/blog7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/blog7/" itemprop="url">MySQL创建数据库与创建用户以及授权</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T11:12:00+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>create schema [数据库名称] default character set utf8 collate utf8_general_ci;–创建数据库<br><br>　　采用create schema和create database创建数据库的效果一样。</li>
<li>create user ‘[用户名称]‘@’%’ identified by ‘[用户密码]’;–创建用户<br><br>　　密码8位以上，包括：大写字母、小写字母、数字、特殊字符<br><br>　　%：匹配所有主机，该地方还可以设置成‘localhost’，代表只能本地访问，例如root账户默认为‘localhost‘</li>
<li>grant select,insert,update,delete,create on [数据库名称].<em> to [用户名称];–用户授权数据库<br>
　　</em>代表整个数据库</li>
<li>flush  privileges ;–立即启用修改</li>
<li>revoke all on <em>.</em> from tester;–取消用户所有数据库（表）的所有权限</li>
<li>delete from mysql.user where user=’tester’;–删除用户</li>
<li>drop database [schema名称|数据库名称];–删除数据库</li>
</ol>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/03/27/blog6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/blog6/" itemprop="url">macOS使用OpenSSL生成 RSA公钥与私钥</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T11:08:54+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>macOS自带openssl环境，不用安装，直接使用openssl就可以<br><br><br>打开终端，进入到即将生成密钥文件的目录下，然后输入命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">openssl</span><br><span class="line">genrsa -out rsa_private_key.pem <span class="comment">#2048生成私钥</span></span><br><span class="line">pkcs8 -topk8 -inform PEM -<span class="keyword">in</span> rsa_private_key.pem -outform PEM -nocrypt -out rsa_private_key_pkcs8.pem <span class="comment">#将私钥转换成PKCS8格式</span></span><br><span class="line">rsa -<span class="keyword">in</span> rsa_private_key.pem -pubout -out rsa_public_key.pem <span class="comment">#生成公钥</span></span><br><span class="line"><span class="built_in">exit</span> <span class="comment">#退出</span></span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/03/27/blog5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/blog5/" itemprop="url">搭建memcached服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T11:07:08+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="安装-libevent"><a href="#安装-libevent" class="headerlink" title="安装 libevent"></a>安装 libevent</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf libevent-2.1.8-stable.tar.gz</span><br><span class="line">./configure --prefix=/usr/libevent</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h4 id="安装-memcached"><a href="#安装-memcached" class="headerlink" title="安装 memcached"></a>安装 memcached</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl http://memcached.org/files/memcached-1.5.1.tar.gz -o memcached-1.5.1.tar.gz</span><br><span class="line">tar -zxvf memcached-1.5.1.tar.gz</span><br><span class="line">./configure --prefix=/usr/memcached --with-libevent=/usr/libevent</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">./memcached -u root -d -p 11211</span><br></pre></td></tr></table></figure>
<h4 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=11211/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=11211/udp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/03/27/blog4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="静谧星空">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="静谧星空的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/blog4/" itemprop="url">搭建redis服务器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T11:03:49+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="安装-EPEL-源"><a href="#安装-EPEL-源" class="headerlink" title="安装 EPEL 源"></a>安装 EPEL 源</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum -y install yum-utils</span><br><span class="line">yum-config-manager --<span class="built_in">enable</span> rhui-REGION-rhel-server-extras rhui-REGION-rhel-server-optional</span><br></pre></td></tr></table></figure>
<h4 id="安装C"><a href="#安装C" class="headerlink" title="安装C"></a>安装C</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc</span><br></pre></td></tr></table></figure>
<h4 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl http://download.redis.io/releases/redis-4.0.1.tar.gz -o redis-4.0.1.tar.gz</span><br><span class="line">tar xzf redis-4.0.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-4.0.1</span><br><span class="line">make MALLOC=libc</span><br><span class="line"></span><br><span class="line">./redis-server ./redis.conf</span><br></pre></td></tr></table></figure>
<p>开放端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=6379/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --add-port=6379/udp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<p><br></p>
<h3 id="redis-conf-配置项说明如下："><a href="#redis-conf-配置项说明如下：" class="headerlink" title="redis.conf 配置项说明如下："></a>redis.conf 配置项说明如下：</h3><ol>
<li><p>Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程<br>daemonize no</p>
</li>
<li><p>当Redis以守护进程方式运行时，Redis默认会把pid写入/var/run/redis.pid文件，可以通过pidfile指定<br>pidfile /var/run/redis.pid</p>
</li>
<li><p>指定Redis监听端口，默认端口为6379，作者在自己的一篇博文中解释了为什么选用6379作为默认端口，因为6379在手机按键上MERZ对应的号码，而MERZ取自意大利歌女Alessia Merz的名字<br>port 6379</p>
</li>
<li><p>绑定的主机地址<br>bind 127.0.0.1</p>
</li>
<li><p>当客户端闲置多长时间后关闭连接，如果指定为0，表示关闭该功能<br>timeout 300</p>
</li>
<li><p>指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose<br>loglevel verbose</p>
</li>
<li><p>日志记录方式，默认为标准输出，如果配置Redis为守护进程方式运行，而这里又配置为日志记录方式为标准输出，则日志将会发送给/dev/null<br>logfile stdout</p>
</li>
<li><p>设置数据库的数量，默认数据库为0，可以使用SELECT <dbid>命令在连接上指定数据库id<br>databases 16</dbid></p>
</li>
<li><p>指定在多长时间内，有多少次更新操作，就将数据同步到数据文件，可以多个条件配合<br>save <seconds> <changes><br>Redis默认配置文件中提供了三个条件：<br>save 900 1<br>save 300 10<br>save 60 10000<br>分别表示900秒（15分钟）内有1个更改，300秒（5分钟）内有10个更改以及60秒内有10000个更改。</changes></seconds></p>
</li>
<li><p>指定存储至本地数据库时是否压缩数据，默认为yes，Redis采用LZF压缩，如果为了节省CPU时间，可以关闭该选项，但会导致数据库文件变的巨大<br>rdbcompression yes</p>
</li>
<li><p>指定本地数据库文件名，默认值为dump.rdb<br>dbfilename dump.rdb</p>
</li>
<li><p>指定本地数据库存放目录<br>dir ./</p>
</li>
<li><p>设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步<br>slaveof <masterip> <masterport></masterport></masterip></p>
</li>
<li><p>当master服务设置了密码保护时，slav服务连接master的密码<br>masterauth <master-password></master-password></p>
</li>
<li><p>设置Redis连接密码，如果配置了连接密码，客户端在连接Redis时需要通过AUTH <password>命令提供密码，默认关闭<br>requirepass foobared</password></p>
</li>
<li><p>设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息<br>maxclients 128</p>
</li>
<li><p>指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key，当此方法处理 后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis新的vm机制，会把Key存放内存，Value会存放在swap区<br>maxmemory <bytes></bytes></p>
</li>
<li><p>指定是否在每次更新操作后进行日志记录，Redis在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为 redis本身同步数据文件是按上面save条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为no<br>appendonly no</p>
</li>
<li><p>指定更新日志文件名，默认为appendonly.aof<br>appendfilename appendonly.aof</p>
</li>
<li><p>指定更新日志条件，共有3个可选值：<br>no：表示等操作系统进行数据缓存同步到磁盘（快）<br>always：表示每次更新操作后手动调用fsync()将数据写到磁盘（慢，安全）<br>everysec：表示每秒同步一次（折衷，默认值）<br>appendfsync everysec</p>
</li>
<li><p>指定是否启用虚拟内存机制，默认值为no，简单的介绍一下，VM机制将数据分页存放，由Redis将访问量较少的页即冷数据swap到磁盘上，访问多的页面由磁盘自动换出到内存中（在后面的文章我会仔细分析Redis的VM机制）<br>vm-enabled no</p>
</li>
<li><p>虚拟内存文件路径，默认值为/tmp/redis.swap，不可多个Redis实例共享<br>vm-swap-file /tmp/redis.swap</p>
</li>
<li><p>将所有大于vm-max-memory的数据存入虚拟内存,无论vm-max-memory设置多小,所有索引数据都是内存存储的(Redis的索引数据 就是keys),也就是说,当vm-max-memory设置为0的时候,其实是所有value都存在于磁盘。默认值为0<br>vm-max-memory 0</p>
</li>
<li><p>Redis swap文件分成了很多的page，一个对象可以保存在多个page上面，但一个page上不能被多个对象共享，vm-page-size是要根据存储的 数据大小来设定的，作者建议如果存储很多小对象，page大小最好设置为32或者64bytes；如果存储很大大对象，则可以使用更大的page，如果不 确定，就使用默认值<br>vm-page-size 32</p>
</li>
<li><p>设置swap文件中的page数量，由于页表（一种表示页面空闲或使用的bitmap）是在放在内存中的，，在磁盘上每8个pages将消耗1byte的内存。<br>vm-pages 134217728</p>
</li>
<li><p>设置访问swap文件的线程数,最好不要超过机器的核数,如果设置为0,那么所有对swap文件的操作都是串行的，可能会造成比较长时间的延迟。默认值为4<br>vm-max-threads 4</p>
</li>
<li><p>设置在向客户端应答时，是否把较小的包合并为一个包发送，默认为开启<br>glueoutputbuf yes</p>
</li>
<li><p>指定在超过一定的数量或者最大的元素超过某一临界值时，采用一种特殊的哈希算法<br>hash-max-zipmap-entries 64<br>hash-max-zipmap-value 512</p>
</li>
<li><p>指定是否激活重置哈希，默认为开启（后面在介绍Redis的哈希算法时具体介绍）<br>activerehashing yes</p>
</li>
<li><p>指定包含其它的配置文件，可以在同一主机上多个Redis实例之间使用同一份配置文件，而同时各个实例又拥有自己的特定配置文件<br>include /path/to/local.conf</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    <div>
      
    </div>

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">静谧星空</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">静谧星空</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
