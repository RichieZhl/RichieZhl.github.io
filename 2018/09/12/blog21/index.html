<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS," />










<meta name="description" content="dispatch_object_t所有GCD结构体的联合体，可以表示任意GCD对象">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="GCD 队列探索">
<meta property="og:url" content="https://blog.msrily.com/2018/09/12/blog21/index.html">
<meta property="og:site_name" content="RICHIE">
<meta property="og:description" content="dispatch_object_t所有GCD结构体的联合体，可以表示任意GCD对象">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-10-06T18:08:28.972Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GCD 队列探索">
<meta name="twitter:description" content="dispatch_object_t所有GCD结构体的联合体，可以表示任意GCD对象">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://blog.msrily.com/2018/09/12/blog21/"/>





  <title>GCD 队列探索 | RICHIE</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">RICHIE</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://blog.msrily.com/2018/09/12/blog21/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Richie Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="RICHIE">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">GCD 队列探索</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-12T14:50:46+08:00">
                2018-09-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/原创/" itemprop="url" rel="index">
                    <span itemprop="name">原创</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="dispatch-object-t"><a href="#dispatch-object-t" class="headerlink" title="dispatch_object_t"></a>dispatch_object_t</h3><p>所有GCD结构体的联合体，可以表示任意GCD对象<br><a id="more"></a><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> *_<span class="title">os_obj</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> *_<span class="title">do</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *_<span class="title">dc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> *_<span class="title">dq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_attr_s</span> *_<span class="title">dqa</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_group_s</span> *_<span class="title">dg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_s</span> *_<span class="title">ds</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_mach_s</span> *_<span class="title">dm</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_mach_msg_s</span> *_<span class="title">dmsg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_attr_s</span> *_<span class="title">dsa</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_semaphore_s</span> *_<span class="title">dsema</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_data_s</span> *_<span class="title">ddata</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_io_s</span> *_<span class="title">dchannel</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_operation_s</span> *_<span class="title">doperation</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_disk_s</span> *_<span class="title">ddisk</span>;</span></span><br><span class="line">&#125; <span class="keyword">dispatch_object_t</span> DISPATCH_TRANSPARENT_UNION;</span><br></pre></td></tr></table></figure></p>
<h4 id="os-object-s"><a href="#os-object-s" class="headerlink" title="_os_object_s"></a>_os_object_s</h4><p>OC对象</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_vtable_s</span> &#123;</span></span><br><span class="line">	_void *<span class="keyword">_os_obj_objc_class_t</span>[<span class="number">5</span>];</span><br><span class="line">&#125; _os_object_vtable_s;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">const</span> _os_object_vtable_s *os_obj_isa;</span><br><span class="line">	<span class="keyword">int</span> <span class="keyword">volatile</span> os_obj_ref_cnt;</span><br><span class="line">	<span class="keyword">int</span> <span class="keyword">volatile</span> os_obj_xref_cnt;</span><br><span class="line">&#125; _os_object_s;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-object-s"><a href="#dispatch-object-s" class="headerlink" title="dispatch_object_s"></a>dispatch_object_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span>;</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_extra_vtable_s</span> &#123;</span> </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">const</span> do_type; </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *<span class="keyword">const</span> do_kind; </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_invoke)(struct dispatch_object_s *, <span class="keyword">dispatch_invoke_context_t</span>, </span><br><span class="line">            <span class="keyword">dispatch_invoke_flags_t</span>); </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_push)(struct dispatch_object_s *, <span class="keyword">dispatch_object_t</span>, </span><br><span class="line">            <span class="keyword">dispatch_qos_t</span>) </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_wakeup)(struct dispatch_object_s *, </span><br><span class="line">            <span class="keyword">dispatch_qos_t</span>, <span class="keyword">dispatch_wakeup_flags_t</span>); </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_dispose)(struct dispatch_object_s *, <span class="keyword">bool</span> *allow_free) </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_set_targetq)(struct dispatch_object_s *, <span class="keyword">dispatch_queue_t</span>); </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_suspend)(struct dispatch_object_s *); </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_resume)(struct dispatch_object_s *, </span><br><span class="line">            <span class="keyword">bool</span> activate); </span><br><span class="line">    <span class="keyword">void</span> (*<span class="keyword">const</span> do_finalize_activation)(struct dispatch_object_s *, <span class="keyword">bool</span> *allow_resume); </span><br><span class="line">    <span class="keyword">size_t</span> (*<span class="keyword">const</span> do_debug)(struct dispatch_object_s *, <span class="keyword">char</span> *, <span class="keyword">size_t</span>)</span><br><span class="line">&#125;; </span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> *_<span class="title">os_object_t</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_vtable_s</span> &#123;</span> </span><br><span class="line">    <span class="keyword">void</span> (*_os_obj_xref_dispose)(<span class="keyword">_os_object_t</span>);</span><br><span class="line">    <span class="keyword">void</span> (*_os_obj_dispose)(<span class="keyword">_os_object_t</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_extra_vtable_s</span> _<span class="title">os_obj_vtable</span>;</span> </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> _<span class="title">as_os_obj</span>[0];</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_vtable_s</span> *<span class="title">do_vtable</span>;</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_ref_cnt;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_xref_cnt;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> *<span class="title">volatile</span> <span class="title">do_next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> *<span class="title">do_targetq</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *do_ctxt;</span><br><span class="line">    <span class="keyword">void</span> *do_finalizer;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-continuation-s"><a href="#dispatch-continuation-s" class="headerlink" title="dispatch_continuation_s"></a>dispatch_continuation_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">voucher_s</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">voucher_vtable_s</span> *<span class="title">os_obj_isa</span>;</span></span><br><span class="line">	<span class="keyword">int</span> <span class="keyword">volatile</span> os_obj_ref_cnt;</span><br><span class="line">	<span class="keyword">int</span> <span class="keyword">volatile</span> os_obj_xref_cnt;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">voucher_hash_entry_s</span> &#123;</span></span><br><span class="line">		<span class="keyword">uintptr_t</span> vhe_next;</span><br><span class="line">		<span class="keyword">uintptr_t</span> vhe_prev_ptr;</span><br><span class="line">	&#125; v_list;</span><br><span class="line">	<span class="keyword">mach_voucher_t</span> v_kvoucher, v_ipc_kvoucher; <span class="comment">// if equal, only one reference</span></span><br><span class="line">	<span class="keyword">voucher_t</span> v_kvbase; <span class="comment">// if non-NULL, v_kvoucher is a borrowed reference</span></span><br><span class="line">	<span class="keyword">firehose_activity_id_t</span> v_activity;</span><br><span class="line">	<span class="keyword">uint64_t</span> v_activity_creator;</span><br><span class="line">	<span class="keyword">firehose_activity_id_t</span> v_parent_activity;</span><br><span class="line">	<span class="keyword">_voucher_priority_t</span> v_priority;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> v_kv_has_importance:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> VOUCHER_ENABLE_RECIPE_OBJECTS</span></span><br><span class="line">	<span class="keyword">size_t</span> v_recipe_extra_offset;</span><br><span class="line">	<span class="keyword">mach_voucher_attr_recipe_size_t</span> v_recipe_extra_size;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; voucher_s;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> _<span class="title">as_do</span>[0];</span></span><br><span class="line">        <span class="keyword">union</span> &#123; </span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">void</span> *do_vtable; </span><br><span class="line">		<span class="keyword">uintptr_t</span> dc_flags; </span><br><span class="line">	&#125;; </span><br><span class="line">	<span class="keyword">union</span> &#123; </span><br><span class="line">		<span class="keyword">pthread_priority_t</span> dc_priority; </span><br><span class="line">		<span class="keyword">int</span> dc_cache_cnt; </span><br><span class="line">		<span class="keyword">uintptr_t</span> dc_pad; </span><br><span class="line">	&#125;; </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *<span class="title">volatile</span> <span class="title">do_next</span>;</span> </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">voucher_s</span> *<span class="title">dc_voucher</span>;</span> </span><br><span class="line">	<span class="keyword">dispatch_function_t</span> dc_func; </span><br><span class="line">	<span class="keyword">void</span> *dc_ctxt; </span><br><span class="line">	<span class="keyword">void</span> *dc_data; </span><br><span class="line">	<span class="keyword">void</span> *dc_other;</span><br><span class="line">&#125; *<span class="keyword">dispatch_continuation_t</span>;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-queue-s"><a href="#dispatch-queue-s" class="headerlink" title="dispatch_queue_s"></a>dispatch_queue_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">os_mpsc_queue_s</span> _<span class="title">as_oq</span>[0];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> _<span class="title">as_do</span>[0];</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> _<span class="title">as_os_obj</span>[0];</span> </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_vtable_s</span> *<span class="title">do_vtable</span>;</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_ref_cnt;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_xref_cnt;</span><br><span class="line">    OS_OBJECT_STRUCT_HEADER(dispatch_queue); </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> *<span class="title">volatile</span> <span class="title">do_next</span>;</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> *<span class="title">do_targetq</span>;</span> </span><br><span class="line">    <span class="keyword">void</span> *do_ctxt; </span><br><span class="line">    <span class="keyword">void</span> *do_finalizer;</span><br><span class="line">    _OS_MPSC_QUEUE_FIELDS(dq, dq_state); </span><br><span class="line">    <span class="keyword">uint32_t</span> dq_side_suspend_cnt; </span><br><span class="line">    dispatch_unfair_lock_s dq_sidelock; </span><br><span class="line">    <span class="keyword">union</span> &#123; </span><br><span class="line">        <span class="keyword">dispatch_queue_t</span> dq_specific_q; </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_refs_s</span> *<span class="title">ds_refs</span>;</span> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_timer_source_refs_s</span> *<span class="title">ds_timer_refs</span>;</span> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_mach_recv_refs_s</span> *<span class="title">dm_recv_refs</span>;</span> </span><br><span class="line">    &#125;; </span><br><span class="line">    DISPATCH_UNION_LE(<span class="keyword">uint32_t</span> <span class="keyword">volatile</span> dq_atomic_flags, </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint16_t</span> dq_width, </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint16_t</span> __dq_opaque </span><br><span class="line">    ); </span><br><span class="line">    <span class="keyword">char</span> _dq_pad[DISPATCH_QUEUE_CACHELINE_PAD]; <span class="comment">// for static queues only</span></span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-queue-attr-s"><a href="#dispatch-queue-attr-s" class="headerlink" title="dispatch_queue_attr_s"></a>dispatch_queue_attr_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_attr_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_attr_vtable_s</span> *<span class="title">do_vtable</span>;</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_ref_cnt;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_xref_cnt;</span><br><span class="line">    <span class="keyword">dispatch_priority_requested_t</span> dqa_qos_and_relpri;</span><br><span class="line">    <span class="keyword">uint16_t</span> dqa_overcommit:<span class="number">2</span>; <span class="comment">// queue创建的线程数是否允许超过实际的CPU个数</span></span><br><span class="line">    <span class="keyword">uint16_t</span> dqa_autorelease_frequency:<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> dqa_concurrent:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uint16_t</span> dqa_inactive:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-group-s"><a href="#dispatch-group-s" class="headerlink" title="dispatch_group_s"></a>dispatch_group_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_group_s</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> _<span class="title">as_do</span>[0];</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> _<span class="title">as_os_obj</span>[0];</span> </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_group_vtable_s</span> *<span class="title">do_vtable</span>;</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_ref_cnt;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_xref_cnt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_group_s</span> *<span class="title">volatile</span> <span class="title">do_next</span>;</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> *<span class="title">do_targetq</span>;</span> </span><br><span class="line">    <span class="keyword">void</span> *do_ctxt; </span><br><span class="line">    <span class="keyword">void</span> *do_finalizer;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">volatile</span> dg_value; </span><br><span class="line">    <span class="keyword">_dispatch_sema4_t</span> dg_sema;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> dg_waiters;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *<span class="title">volatile</span> <span class="title">dg_notify_head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *<span class="title">volatile</span> <span class="title">dg_notify_tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-source-s"><a href="#dispatch-source-s" class="headerlink" title="dispatch_source_s"></a>dispatch_source_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_s</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> _<span class="title">as_dq</span>[0];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">os_mpsc_queue_s</span> _<span class="title">as_oq</span>[0];</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> _<span class="title">as_do</span>[0];</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> _<span class="title">as_os_obj</span>[0];</span> </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_vtable_s</span> *<span class="title">do_vtable</span>;</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_ref_cnt;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_xref_cnt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_s</span> *<span class="title">volatile</span> <span class="title">do_next</span>;</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> *<span class="title">do_targetq</span>;</span> </span><br><span class="line">    <span class="keyword">void</span> *do_ctxt; </span><br><span class="line">    <span class="keyword">void</span> *do_finalizer;</span><br><span class="line">    _OS_MPSC_QUEUE_FIELDS(dq, dq_state); </span><br><span class="line">    <span class="keyword">uint32_t</span> dq_side_suspend_cnt; </span><br><span class="line">    dispatch_unfair_lock_s dq_sidelock; </span><br><span class="line">    <span class="keyword">union</span> &#123; </span><br><span class="line">        <span class="keyword">dispatch_queue_t</span> dq_specific_q; </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_source_refs_s</span> *<span class="title">ds_refs</span>;</span> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_timer_source_refs_s</span> *<span class="title">ds_timer_refs</span>;</span> </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_mach_recv_refs_s</span> *<span class="title">dm_recv_refs</span>;</span> </span><br><span class="line">    &#125;; </span><br><span class="line">    DISPATCH_UNION_LE(<span class="keyword">uint32_t</span> <span class="keyword">volatile</span> dq_atomic_flags, </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint16_t</span> dq_width, </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">uint16_t</span> __dq_opaque </span><br><span class="line">    ); </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span></span><br><span class="line">        ds_is_installed:<span class="number">1</span>, </span><br><span class="line">        dm_needs_mgr:<span class="number">1</span>, </span><br><span class="line">        dm_connect_handler_called:<span class="number">1</span>, </span><br><span class="line">        dm_uninstalled:<span class="number">1</span>, </span><br><span class="line">        dm_cancel_handler_called:<span class="number">1</span>, </span><br><span class="line">        dm_is_xpc:<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> ds_data DISPATCH_ATOMIC64_ALIGN;</span><br><span class="line">    <span class="keyword">uint64_t</span> ds_pending_data DISPATCH_ATOMIC64_ALIGN;</span><br><span class="line">&#125; __attribute__((aligned(<span class="number">8</span>)));</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-semaphore-s"><a href="#dispatch-semaphore-s" class="headerlink" title="dispatch_semaphore_s"></a>dispatch_semaphore_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_semaphore_s</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> _<span class="title">as_do</span>[0];</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">os_object_s</span> _<span class="title">as_os_obj</span>[0];</span> </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_semaphore_vtable_s</span> *<span class="title">do_vtable</span>;</span></span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_ref_cnt;</span><br><span class="line">    <span class="keyword">int</span> <span class="keyword">volatile</span> do_xref_cnt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_semaphore_s</span> *<span class="title">volatile</span> <span class="title">do_next</span>;</span> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> *<span class="title">do_targetq</span>;</span> </span><br><span class="line">    <span class="keyword">void</span> *do_ctxt; </span><br><span class="line">    <span class="keyword">void</span> *do_finalizer;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">volatile</span> dsema_value; </span><br><span class="line">    <span class="keyword">_dispatch_sema4_t</span> dsema_sema;</span><br><span class="line">    <span class="keyword">long</span> dsema_orig;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-data-s"><a href="#dispatch-data-s" class="headerlink" title="dispatch_data_s"></a>dispatch_data_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(^<span class="keyword">dispatch_block_t</span>)</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_data_s</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_data_s</span> *<span class="title">dispatch_data_t</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">range_record_s</span> &#123;</span></span><br><span class="line">	<span class="keyword">dispatch_data_t</span> data_object;</span><br><span class="line">	<span class="keyword">size_t</span> from;</span><br><span class="line">	<span class="keyword">size_t</span> length;</span><br><span class="line">&#125; range_record;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_data_s</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_DATA_IS_BRIDGED_TO_NSDATA</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *do_vtable;</span><br><span class="line">	<span class="keyword">dispatch_queue_t</span> do_targetq;</span><br><span class="line">	<span class="keyword">void</span> *ctxt;</span><br><span class="line">	<span class="keyword">void</span> *finalizer;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	DISPATCH_OBJECT_HEADER(data);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// DISPATCH_DATA_IS_BRIDGED_TO_NSDATA</span></span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *buf;</span><br><span class="line">	<span class="keyword">dispatch_block_t</span> destructor;</span><br><span class="line">	<span class="keyword">size_t</span> size, num_records;</span><br><span class="line">	range_record records[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-sync-context-s"><a href="#dispatch-sync-context-s" class="headerlink" title="dispatch_sync_context_s"></a>dispatch_sync_context_s</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_sync_context_s</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> _<span class="title">as_do</span>[0];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> _<span class="title">as_dc</span>[0];</span></span><br><span class="line">	DISPATCH_CONTINUATION_HEADER(continuation);</span><br><span class="line">	<span class="keyword">dispatch_function_t</span> dsc_func;</span><br><span class="line">	<span class="keyword">void</span> *dsc_ctxt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_COCOA_COMPAT</span></span><br><span class="line">	dispatch_thread_frame_s dsc_dtf;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	dispatch_thread_event_s dsc_event;</span><br><span class="line">	dispatch_tid dsc_waiter;</span><br><span class="line">	<span class="keyword">dispatch_qos_t</span> dsc_override_qos_floor;</span><br><span class="line">	<span class="keyword">dispatch_qos_t</span> dsc_override_qos;</span><br><span class="line">	<span class="keyword">bool</span> dsc_wlh_was_first;</span><br><span class="line">	<span class="keyword">bool</span> dsc_release_storage;</span><br><span class="line">&#125; *<span class="keyword">dispatch_sync_context_t</span>;</span><br></pre></td></tr></table></figure>
<h3 id="dispatch-queue"><a href="#dispatch-queue" class="headerlink" title="dispatch queue"></a>dispatch queue</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> _<span class="title">dispatch_root_queues</span>[] = &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DISPATCH_ROOT_QUEUE_IDX(n, flags) \</span></span><br><span class="line">	((flags &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT) ? \</span><br><span class="line">		DISPATCH_ROOT_QUEUE_IDX_##n##_QOS_OVERCOMMIT : \</span><br><span class="line">		DISPATCH_ROOT_QUEUE_IDX_##n##_QOS)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _DISPATCH_ROOT_QUEUE_ENTRY(n, flags, ...) \</span></span><br><span class="line">	[_DISPATCH_ROOT_QUEUE_IDX(n, flags)] = &#123; \</span><br><span class="line">		DISPATCH_GLOBAL_OBJECT_HEADER(queue_root), \</span><br><span class="line">		.dq_state = DISPATCH_ROOT_QUEUE_STATE_INIT_VALUE, \</span><br><span class="line">		.do_ctxt = &amp;_dispatch_root_queue_contexts[ \</span><br><span class="line">				_DISPATCH_ROOT_QUEUE_IDX(n, flags)], \</span><br><span class="line">		.dq_atomic_flags = DQF_WIDTH(DISPATCH_QUEUE_WIDTH_POOL), \</span><br><span class="line">		.dq_priority = _dispatch_priority_make(DISPATCH_QOS_##n, <span class="number">0</span>) | flags | \</span><br><span class="line">				DISPATCH_PRIORITY_FLAG_ROOTQUEUE | \</span><br><span class="line">				((flags &amp; DISPATCH_PRIORITY_FLAG_DEFAULTQUEUE) ? <span class="number">0</span> : \</span><br><span class="line">				DISPATCH_QOS_##n &lt;&lt; DISPATCH_PRIORITY_OVERRIDE_SHIFT), \</span><br><span class="line">		__VA_ARGS__ \</span><br><span class="line">	&#125;</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(MAINTENANCE, <span class="number">0</span>,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.maintenance-qos"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">4</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(MAINTENANCE, DISPATCH_PRIORITY_FLAG_OVERCOMMIT,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.maintenance-qos.overcommit"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">5</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(BACKGROUND, <span class="number">0</span>,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.background-qos"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">6</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(BACKGROUND, DISPATCH_PRIORITY_FLAG_OVERCOMMIT,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.background-qos.overcommit"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">7</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(UTILITY, <span class="number">0</span>,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.utility-qos"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">8</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(UTILITY, DISPATCH_PRIORITY_FLAG_OVERCOMMIT,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.utility-qos.overcommit"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">9</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(DEFAULT, DISPATCH_PRIORITY_FLAG_DEFAULTQUEUE,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.default-qos"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">10</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(DEFAULT,</span><br><span class="line">			DISPATCH_PRIORITY_FLAG_DEFAULTQUEUE | DISPATCH_PRIORITY_FLAG_OVERCOMMIT,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.default-qos.overcommit"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">11</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(USER_INITIATED, <span class="number">0</span>,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.user-initiated-qos"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">12</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(USER_INITIATED, DISPATCH_PRIORITY_FLAG_OVERCOMMIT,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.user-initiated-qos.overcommit"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">13</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(USER_INTERACTIVE, <span class="number">0</span>,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.user-interactive-qos"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">14</span>,</span><br><span class="line">	),</span><br><span class="line">	_DISPATCH_ROOT_QUEUE_ENTRY(USER_INTERACTIVE, DISPATCH_PRIORITY_FLAG_OVERCOMMIT,</span><br><span class="line">		.dq_label = <span class="string">"com.apple.root.user-interactive-qos.overcommit"</span>,</span><br><span class="line">		.dq_serialnum = <span class="number">15</span>,</span><br><span class="line">	),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>系统维护12个<code>root queue</code>，可分成两组：<code>DISPATCH_ROOT_QUEUE_IDX_XXX_QOS</code>和<code>DISPATCH_ROOT_QUEUE_IDX_XXX_QOS_OVERCOMMIT</code></p>
<h4 id="获取queue"><a href="#获取queue" class="headerlink" title="获取queue"></a>获取queue</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">dispatch_queue_t</span></span><br><span class="line">_dispatch_get_root_queue(<span class="keyword">dispatch_qos_t</span> qos, <span class="keyword">bool</span> overcommit) &#123;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(qos == DISPATCH_QOS_UNSPECIFIED || qos &gt; DISPATCH_QOS_MAX)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(qos, <span class="string">"Corrupted priority"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;_dispatch_root_queues[<span class="number">2</span> * (qos - <span class="number">1</span>) + overcommit];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="main-mgr-root-queue-init"><a href="#main-mgr-root-queue-init" class="headerlink" title="main/mgr/root queue init"></a>main/mgr/root queue init</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">libdispatch_init</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line"><span class="comment">// 主线程优级级设置</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_PTHREAD_WORKQUEUE_QOS</span></span><br><span class="line">	<span class="keyword">dispatch_qos_t</span> qos = _dispatch_qos_from_qos_class(qos_class_main());</span><br><span class="line">	<span class="keyword">dispatch_priority_t</span> pri = _dispatch_priority_make(qos, <span class="number">0</span>);</span><br><span class="line">	_dispatch_main_q.dq_priority = _dispatch_priority_with_override_qos(pri, qos);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_DEBUG</span></span><br><span class="line">	<span class="keyword">if</span> (!slowpath(getenv(<span class="string">"LIBDISPATCH_DISABLE_SET_QOS"</span>))) &#123;</span><br><span class="line">		_dispatch_set_qos_class_enabled = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_USE_THREAD_LOCAL_STORAGE</span></span><br><span class="line">	_dispatch_thread_key_create(&amp;__dispatch_tsd_key, _libdispatch_tsd_cleanup);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_priority_key, <span class="literal">NULL</span>);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_r2k_key, <span class="literal">NULL</span>);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_queue_key, _dispatch_queue_cleanup);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_frame_key, _dispatch_frame_cleanup);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_cache_key, _dispatch_cache_cleanup);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_context_key, _dispatch_context_cleanup);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_pthread_root_queue_observer_hooks_key,</span><br><span class="line">			<span class="literal">NULL</span>);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_basepri_key, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_INTROSPECTION</span></span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_introspection_key , <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> DISPATCH_PERF_MON</span></span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_bcounter_key, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_wlh_key, _dispatch_wlh_cleanup);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_voucher_key, _voucher_thread_cleanup);</span><br><span class="line">	_dispatch_thread_key_create(&amp;dispatch_deferred_items_key,</span><br><span class="line">			_dispatch_deferred_items_cleanup);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 从root queue contexts中取出 DISPATCH_ROOT_QUEUE_IDX_DEFAULT_QOS_OVERCOMMIT的queue */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_USE_RESOLVERS <span class="comment">// rdar://problem/8541707</span></span></span><br><span class="line">	_dispatch_main_q.do_targetq = &amp;_dispatch_root_queues[</span><br><span class="line">			DISPATCH_ROOT_QUEUE_IDX_DEFAULT_QOS_OVERCOMMIT];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	_dispatch_queue_set_current(&amp;_dispatch_main_q);</span><br><span class="line">	_dispatch_queue_set_bound_thread(&amp;_dispatch_main_q);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> DISPATCH_USE_PTHREAD_ATFORK</span></span><br><span class="line">	(<span class="keyword">void</span>)dispatch_assume_zero(pthread_atfork(dispatch_atfork_prepare,</span><br><span class="line">			dispatch_atfork_parent, dispatch_atfork_child));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	_dispatch_hw_config_init();</span><br><span class="line">	_dispatch_time_init() = &#123;</span><br><span class="line">            #<span class="keyword">if</span> DISPATCH_USE_HOST_TIME</span><br><span class="line">                <span class="keyword">mach_timebase_info_data_t</span> tbi;</span><br><span class="line">                (<span class="keyword">void</span>)dispatch_assume_zero(mach_timebase_info(&amp;tbi));</span><br><span class="line">                _dispatch_host_time_init(&amp;tbi);</span><br><span class="line">            <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// DISPATCH_USE_HOST_TIME</span></span></span><br><span class="line">        &#125;;</span><br><span class="line">	_dispatch_vtable_init();</span><br><span class="line">	_os_object_init();</span><br><span class="line">	_voucher_init();</span><br><span class="line">	_dispatch_introspection_init() = &#123;</span><br><span class="line">            TAILQ_INSERT_TAIL(&amp;_dispatch_introspection.queues,</span><br><span class="line">                &amp;_dispatch_main_q, diq_list);  <span class="comment">//主线程的初始化</span></span><br><span class="line">            TAILQ_INSERT_TAIL(&amp;_dispatch_introspection.queues,</span><br><span class="line">                    &amp;_dispatch_mgr_q, diq_list); <span class="comment">//管理线程的初始化</span></span><br><span class="line">        <span class="meta">#<span class="meta-keyword">if</span> DISPATCH_ENABLE_PTHREAD_ROOT_QUEUES</span></span><br><span class="line">            TAILQ_INSERT_TAIL(&amp;_dispatch_introspection.queues,</span><br><span class="line">                    _dispatch_mgr_q.do_targetq, diq_list);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            <span class="comment">/* root queue的初始化 */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; DISPATCH_ROOT_QUEUE_COUNT; i++) &#123;</span><br><span class="line">                TAILQ_INSERT_TAIL(&amp;_dispatch_introspection.queues,</span><br><span class="line">                        &amp;_dispatch_root_queues[i], diq_list);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _dispatch_introspection.debug_queue_inversions =</span><br><span class="line">                    _dispatch_getenv_bool(<span class="string">"LIBDISPATCH_DEBUG_QUEUE_INVERSIONS"</span>, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Hack to determine queue TSD offset from start of pthread structure</span></span><br><span class="line">            <span class="keyword">uintptr_t</span> thread = _dispatch_thread_self();</span><br><span class="line">            <span class="keyword">thread_identifier_info_data_t</span> tiid;</span><br><span class="line">            <span class="keyword">mach_msg_type_number_t</span> cnt = THREAD_IDENTIFIER_INFO_COUNT;</span><br><span class="line">            <span class="keyword">kern_return_t</span> kr = thread_info(pthread_mach_thread_np((<span class="keyword">void</span>*)thread),</span><br><span class="line">                    THREAD_IDENTIFIER_INFO, (<span class="keyword">thread_info_t</span>)&amp;tiid, &amp;cnt);</span><br><span class="line">            <span class="keyword">if</span> (!dispatch_assume_zero(kr)) &#123;</span><br><span class="line">                _dispatch_introspection.thread_queue_offset =</span><br><span class="line">                        (<span class="keyword">void</span>*)(<span class="keyword">uintptr_t</span>)tiid.dispatch_qaddr - (<span class="keyword">void</span>*)thread;</span><br><span class="line">            &#125;</span><br><span class="line">            _dispatch_thread_key_create(&amp;dispatch_introspection_key,</span><br><span class="line">                    _dispatch_introspection_thread_remove);</span><br><span class="line">            _dispatch_introspection_thread_add(); <span class="comment">// add main thread</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="global-queue"><a href="#global-queue" class="headerlink" title="global queue"></a>global queue</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_queue_t</span> dispatch_get_global_queue(<span class="keyword">long</span> priority, <span class="keyword">unsigned</span> <span class="keyword">long</span> flags) &#123;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~(<span class="keyword">unsigned</span> <span class="keyword">long</span>)DISPATCH_QUEUE_OVERCOMMIT) &#123;</span><br><span class="line">		<span class="keyword">return</span> DISPATCH_BAD_INPUT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">dispatch_qos_t</span> qos = _dispatch_qos_from_queue_priority(priority);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !HAVE_PTHREAD_WORKQUEUE_QOS</span></span><br><span class="line">	<span class="keyword">if</span> (qos == QOS_CLASS_MAINTENANCE) &#123;</span><br><span class="line">		qos = DISPATCH_QOS_BACKGROUND;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (qos == QOS_CLASS_USER_INTERACTIVE) &#123;</span><br><span class="line">		qos = DISPATCH_QOS_USER_INITIATED;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">if</span> (qos == DISPATCH_QOS_UNSPECIFIED) &#123;</span><br><span class="line">		<span class="keyword">return</span> DISPATCH_BAD_INPUT;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_get_root_queue(qos, flags &amp; DISPATCH_QUEUE_OVERCOMMIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现<code>global queue</code>是从<code>root queue contexts</code>中取出的可以OVERCOMMIT的 <strong>queue</strong></p>
<h4 id="main-queue"><a href="#main-queue" class="headerlink" title="main queue"></a>main queue</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_queue_s</span> _<span class="title">dispatch_main_q</span> = &#123;</span></span><br><span class="line">	DISPATCH_GLOBAL_OBJECT_HEADER(queue_main),</span><br><span class="line">    <span class="comment">/* 从root queue contexts中取出 DISPATCH_ROOT_QUEUE_IDX_DEFAULT_QOS_OVERCOMMIT的queue */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !DISPATCH_USE_RESOLVERS</span></span><br><span class="line">	.do_targetq = &amp;_dispatch_root_queues[</span><br><span class="line">			DISPATCH_ROOT_QUEUE_IDX_DEFAULT_QOS_OVERCOMMIT],</span><br><span class="line">#endif</span><br><span class="line">	.dq_state = DISPATCH_QUEUE_STATE_INIT_VALUE(<span class="number">1</span>) |</span><br><span class="line">			DISPATCH_QUEUE_ROLE_BASE_ANON,</span><br><span class="line">	.dq_label = <span class="string">"com.apple.main-thread"</span>,</span><br><span class="line">	.dq_atomic_flags = DQF_THREAD_BOUND | DQF_CANNOT_TRYSYNC | DQF_WIDTH(<span class="number">1</span>),</span><br><span class="line">	.dq_serialnum = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> dispatch_get_main_queue(<span class="keyword">void</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> DISPATCH_GLOBAL_OBJECT(<span class="keyword">dispatch_queue_t</span>, _dispatch_main_q); <span class="comment">// 返回就是全局的_dispatch_main_q</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现main queue也是从<code>root queue contexts</code>中取出的</p>
<h4 id="user-queue"><a href="#user-queue" class="headerlink" title="user queue"></a>user queue</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DISPATCH_TARGET_QUEUE_DEFAULT NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dispatch_queue_t</span> dispatch_queue_create(<span class="keyword">const</span> <span class="keyword">char</span> *label, <span class="keyword">dispatch_queue_attr_t</span> attr) &#123; </span><br><span class="line">	<span class="keyword">return</span> _dispatch_queue_create_with_target(label, attr,</span><br><span class="line">			DISPATCH_TARGET_QUEUE_DEFAULT, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">dispatch_queue_t</span> _dispatch_queue_create_with_target(<span class="keyword">const</span> <span class="keyword">char</span> *label, <span class="keyword">dispatch_queue_attr_t</span> dqa,</span><br><span class="line">		<span class="keyword">dispatch_queue_t</span> tq, <span class="keyword">bool</span> legacy) &#123;</span><br><span class="line">	<span class="keyword">if</span> (!slowpath(dqa)) &#123;</span><br><span class="line">		dqa = _dispatch_get_default_queue_attr(); <span class="comment">//如果没有queue属性，使用默认属性</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                dqa.dispatch_priority_requested_t dqa_qos_and_relpri = 0;</span></span><br><span class="line"><span class="comment">                dqa.dqa_overcommit = _dispatch_queue_attr_overcommit_unspecified;</span></span><br><span class="line"><span class="comment">                dqa.dqa_autorelease_frequency = DISPATCH_AUTORELEASE_FREQUENCY_INHERIT;</span></span><br><span class="line"><span class="comment">                dqa.dqa_concurrent = 0;</span></span><br><span class="line"><span class="comment">                dqa.dqa_inactive = 0;</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dqa-&gt;do_vtable != DISPATCH_VTABLE(queue_attr)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(dqa-&gt;do_vtable, <span class="string">"Invalid queue attribute"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Step 1: Normalize arguments (qos, overcommit, tq)</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">dispatch_qos_t</span> qos = _dispatch_priority_qos(dqa-&gt;dqa_qos_and_relpri); <span class="comment">//获取QOS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !HAVE_PTHREAD_WORKQUEUE_QOS</span></span><br><span class="line">	<span class="keyword">if</span> (qos == DISPATCH_QOS_USER_INTERACTIVE) &#123;</span><br><span class="line">		qos = DISPATCH_QOS_USER_INITIATED;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (qos == DISPATCH_QOS_MAINTENANCE) &#123;</span><br><span class="line">		qos = DISPATCH_QOS_BACKGROUND;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// !HAVE_PTHREAD_WORKQUEUE_QOS</span></span></span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">        获取overcommit状态</span></span><br><span class="line"><span class="comment">        非全局target queue不能 overcommit</span></span><br><span class="line"><span class="comment">        如果优先级里有 overcommit 的Flag，则开启 overcommit，反之则关闭</span></span><br><span class="line"><span class="comment">        串行队列默认不开启 overcommit ，并发队列则相反</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">	<span class="keyword">_dispatch_queue_attr_overcommit_t</span> overcommit = dqa-&gt;dqa_overcommit; </span><br><span class="line">	<span class="keyword">if</span> (overcommit != _dispatch_queue_attr_overcommit_unspecified &amp;&amp; tq) &#123;</span><br><span class="line">		<span class="keyword">if</span> (tq-&gt;do_targetq) &#123; </span><br><span class="line">			DISPATCH_CLIENT_CRASH(tq, <span class="string">"Cannot specify both overcommit and "</span></span><br><span class="line">					<span class="string">"a non-global target queue"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tq &amp;&amp; !tq-&gt;do_targetq &amp;&amp;</span><br><span class="line">			tq-&gt;do_ref_cnt == DISPATCH_OBJECT_GLOBAL_REFCNT) &#123;</span><br><span class="line">		<span class="comment">// Handle discrepancies between attr and target queue, attributes win</span></span><br><span class="line">		<span class="keyword">if</span> (overcommit == _dispatch_queue_attr_overcommit_unspecified) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tq-&gt;dq_priority &amp; DISPATCH_PRIORITY_FLAG_OVERCOMMIT) &#123;</span><br><span class="line">				overcommit = _dispatch_queue_attr_overcommit_enabled;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				overcommit = _dispatch_queue_attr_overcommit_disabled;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (qos == DISPATCH_QOS_UNSPECIFIED) &#123;</span><br><span class="line">			<span class="keyword">dispatch_qos_t</span> tq_qos = _dispatch_priority_qos(tq-&gt;dq_priority);</span><br><span class="line">			tq = _dispatch_get_root_queue(tq_qos,</span><br><span class="line">					overcommit == _dispatch_queue_attr_overcommit_enabled);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			tq = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (tq &amp;&amp; !tq-&gt;do_targetq) &#123;</span><br><span class="line">		<span class="comment">// target is a pthread or runloop root queue, setting QoS or overcommit</span></span><br><span class="line">		<span class="comment">// is disallowed</span></span><br><span class="line">		<span class="keyword">if</span> (overcommit != _dispatch_queue_attr_overcommit_unspecified) &#123;</span><br><span class="line">			DISPATCH_CLIENT_CRASH(tq, <span class="string">"Cannot specify an overcommit attribute "</span></span><br><span class="line">					<span class="string">"and use this kind of target queue"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (qos != DISPATCH_QOS_UNSPECIFIED) &#123;</span><br><span class="line">			DISPATCH_CLIENT_CRASH(tq, <span class="string">"Cannot specify a QoS attribute "</span></span><br><span class="line">					<span class="string">"and use this kind of target queue"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (overcommit == _dispatch_queue_attr_overcommit_unspecified) &#123;</span><br><span class="line">			 <span class="comment">// Serial queues default to overcommit!</span></span><br><span class="line">			overcommit = dqa-&gt;dqa_concurrent ?</span><br><span class="line">					_dispatch_queue_attr_overcommit_disabled :</span><br><span class="line">					_dispatch_queue_attr_overcommit_enabled;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// 从 root queue contexts 中取出 label 是 com.apple.root.default-qos 的queue</span></span><br><span class="line">	<span class="keyword">if</span> (!tq) &#123;</span><br><span class="line">		tq = _dispatch_get_root_queue(</span><br><span class="line">				qos == DISPATCH_QOS_UNSPECIFIED ? DISPATCH_QOS_DEFAULT : qos,</span><br><span class="line">				overcommit == _dispatch_queue_attr_overcommit_enabled);</span><br><span class="line">		<span class="keyword">if</span> (slowpath(!tq)) &#123;</span><br><span class="line">			DISPATCH_CLIENT_CRASH(qos, <span class="string">"Invalid queue attribute"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Step 2: Initialize the queue</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (legacy) &#123;</span><br><span class="line">		<span class="comment">// if any of these attributes is specified, use non legacy classes</span></span><br><span class="line">		<span class="keyword">if</span> (dqa-&gt;dqa_inactive || dqa-&gt;dqa_autorelease_frequency) &#123;</span><br><span class="line">			legacy = <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建队列的vtable</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">void</span> *vtable;</span><br><span class="line">	<span class="keyword">dispatch_queue_flags_t</span> dqf = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (legacy) &#123;</span><br><span class="line">		vtable = DISPATCH_VTABLE(<span class="built_in">queue</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (dqa-&gt;dqa_concurrent) &#123;</span><br><span class="line">		vtable = DISPATCH_VTABLE(queue_concurrent);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		vtable = DISPATCH_VTABLE(queue_serial); </span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> (dqa-&gt;dqa_autorelease_frequency) &#123;</span><br><span class="line">	<span class="keyword">case</span> DISPATCH_AUTORELEASE_FREQUENCY_NEVER:</span><br><span class="line">		dqf |= DQF_AUTORELEASE_NEVER;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> DISPATCH_AUTORELEASE_FREQUENCY_WORK_ITEM:</span><br><span class="line">		dqf |= DQF_AUTORELEASE_ALWAYS;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (legacy) &#123;</span><br><span class="line">		dqf |= DQF_LEGACY;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (label) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *tmp = _dispatch_strdup_if_mutable(label);</span><br><span class="line">		<span class="keyword">if</span> (tmp != label) &#123;</span><br><span class="line">			dqf |= DQF_LABEL_NEEDS_FREE;</span><br><span class="line">			label = tmp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">        通过之前创建的vtable创建queue</span></span><br><span class="line"><span class="comment">        设置width为1，即最多可以创建一个线程</span></span><br><span class="line"><span class="comment">        设置queue的targettq是从root queue里取出的queue</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">	<span class="keyword">dispatch_queue_t</span> dq = _dispatch_object_alloc(vtable,</span><br><span class="line">			<span class="keyword">sizeof</span>(struct dispatch_queue_s) - DISPATCH_QUEUE_CACHELINE_PAD);</span><br><span class="line">	_dispatch_queue_init(dq, dqf, dqa-&gt;dqa_concurrent ?</span><br><span class="line">			DISPATCH_QUEUE_WIDTH_MAX : <span class="number">1</span>, DISPATCH_QUEUE_ROLE_INNER |</span><br><span class="line">			(dqa-&gt;dqa_inactive ? DISPATCH_QUEUE_INACTIVE : <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">	dq-&gt;dq_label = label;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> HAVE_PTHREAD_WORKQUEUE_QOS</span></span><br><span class="line">	dq-&gt;dq_priority = dqa-&gt;dqa_qos_and_relpri;</span><br><span class="line">	<span class="keyword">if</span> (overcommit == _dispatch_queue_attr_overcommit_enabled) &#123;</span><br><span class="line">		dq-&gt;dq_priority |= DISPATCH_PRIORITY_FLAG_OVERCOMMIT;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	_dispatch_retain(tq);</span><br><span class="line">	<span class="keyword">if</span> (qos == QOS_CLASS_UNSPECIFIED) &#123;</span><br><span class="line">		<span class="comment">// legacy way of inherithing the QoS from the target</span></span><br><span class="line">		_dispatch_queue_priority_inherit_from_target(dq, tq);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!dqa-&gt;dqa_inactive) &#123;</span><br><span class="line">		_dispatch_queue_inherit_wlh_from_target(dq, tq);</span><br><span class="line">	&#125;</span><br><span class="line">	dq-&gt;do_targetq = tq;</span><br><span class="line">	_dispatch_object_debug(dq, <span class="string">"%s"</span>, __func__);</span><br><span class="line">	<span class="keyword">return</span> _dispatch_introspection_queue_create(dq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatch-sync-async"><a href="#dispatch-sync-async" class="headerlink" title="dispatch sync/async"></a>dispatch sync/async</h3><h4 id="dispatch-sync"><a href="#dispatch-sync" class="headerlink" title="dispatch sync"></a>dispatch sync</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_sync</span><span class="params">(<span class="keyword">dispatch_queue_t</span> dq, <span class="keyword">dispatch_block_t</span> work)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(_dispatch_block_has_private_data(work))) &#123;</span><br><span class="line">		<span class="keyword">return</span> _dispatch_sync_block_with_private_data(dq, work, <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	dispatch_sync_f(dq, work, _dispatch_Block_invoke(work)) = &#123;</span><br><span class="line">            <span class="comment">// 若width为1，则直接调用dispatch_barrier_sync_f</span></span><br><span class="line">            <span class="keyword">if</span> (likely(dq-&gt;dq_width == <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> dispatch_barrier_sync_f(dq, ctxt, func);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Global concurrent queues and queues bound to non-dispatch threads</span></span><br><span class="line">            <span class="comment">// always fall into the slow case, see DISPATCH_ROOT_QUEUE_STATE_INIT_VALUE</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 全局的并发队列会调用_dispatch_sync_f_slow创建线程</span></span><br><span class="line">            <span class="keyword">if</span> (unlikely(!_dispatch_queue_try_reserve_sync_width(dq))) &#123;</span><br><span class="line">                <span class="keyword">return</span> _dispatch_sync_f_slow(dq, ctxt, func, <span class="number">0</span>) = &#123;</span><br><span class="line">                    <span class="comment">//如果有执行队列则开始线程上下文切换并执行</span></span><br><span class="line">                    <span class="keyword">if</span> (unlikely(!dq-&gt;do_targetq)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> _dispatch_sync_function_invoke(dq, ctxt, func) = &#123;</span><br><span class="line">                            dispatch_thread_frame_s dtf;</span><br><span class="line">                            _dispatch_thread_frame_push(&amp;dtf, dq);</span><br><span class="line">                            _dispatch_client_callout(ctxt, func);</span><br><span class="line">                            _dispatch_perfmon_workitem_inc();</span><br><span class="line">                            _dispatch_thread_frame_pop(&amp;dtf);</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//将当前的queue置成执行队列，并等待执行</span></span><br><span class="line">                    _dispatch_sync_wait(dq, ctxt, func, dc_flags, dq, dc_flags) = &#123;</span><br><span class="line">                                <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">                        	_dispatch_introspection_sync_begin(top_dq);</span><br><span class="line">                            <span class="meta">#<span class="meta-keyword">if</span> DISPATCH_COCOA_COMPAT</span></span><br><span class="line">                                <span class="keyword">if</span> (unlikely(dsc.dsc_func == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">                                    <span class="comment">// Queue bound to a non-dispatch thread, the continuation already ran</span></span><br><span class="line">                                    <span class="comment">// so just unlock all the things, except for the thread bound queue</span></span><br><span class="line">                                    <span class="keyword">dispatch_queue_t</span> bound_dq = dsc.dc_other;</span><br><span class="line">                                    <span class="keyword">return</span> _dispatch_sync_complete_recurse(top_dq, bound_dq, top_dc_flags);</span><br><span class="line">                                &#125;</span><br><span class="line">                            <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">                                _dispatch_sync_invoke_and_complete_recurse(top_dq, ctxt, func,top_dc_flags);</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            _dispatch_introspection_sync_begin(dq);</span><br><span class="line">            <span class="keyword">if</span> (unlikely(dq-&gt;do_targetq-&gt;do_targetq)) &#123;</span><br><span class="line">                <span class="keyword">return</span> _dispatch_sync_recurse(dq, ctxt, func, <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _dispatch_sync_invoke_and_complete(dq, ctxt, func);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dispatch_barrier_async会在 flags 加 DISPATCH_BLOCK_BARRIER 值</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_barrier_sync</span><span class="params">(<span class="keyword">dispatch_queue_t</span> dq, <span class="keyword">dispatch_block_t</span> work)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(_dispatch_block_has_private_data(work))) &#123;</span><br><span class="line">		<span class="keyword">dispatch_block_flags_t</span> flags = DISPATCH_BLOCK_BARRIER;</span><br><span class="line">		<span class="keyword">return</span> _dispatch_sync_block_with_private_data(dq, work, flags);</span><br><span class="line">	&#125;</span><br><span class="line">	dispatch_barrier_sync_f(dq, work, _dispatch_Block_invoke(work));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在dispatch wake时执行</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _dispatch_queue_wakeup(<span class="keyword">dispatch_queue_t</span> dq, <span class="keyword">dispatch_qos_t</span> qos,</span><br><span class="line">		<span class="keyword">dispatch_wakeup_flags_t</span> flags) &#123;</span><br><span class="line">	<span class="keyword">dispatch_queue_wakeup_target_t</span> target = DISPATCH_QUEUE_WAKEUP_NONE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(flags &amp; DISPATCH_WAKEUP_BARRIER_COMPLETE)) &#123;</span><br><span class="line">        <span class="comment">// flags里有DISPATCH_WAKEUP_BARRIER_COMPLETE，将当时可如果是串行队列则将执行的dispatch_continuation_t置为1个;如果是并行队列则执行barrier之前的所有的dispatch_continuation_t</span></span><br><span class="line">		<span class="keyword">return</span> _dispatch_queue_barrier_complete(dq, qos, flags) = &#123;</span><br><span class="line">                    <span class="keyword">dispatch_continuation_t</span> dc_tmp, dc_start = <span class="literal">NULL</span>, dc_end = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="keyword">dispatch_queue_wakeup_target_t</span> target = DISPATCH_QUEUE_WAKEUP_NONE;</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_object_s</span> *<span class="title">dc</span> = <span class="title">NULL</span>;</span></span><br><span class="line">                    <span class="keyword">uint64_t</span> owned = DISPATCH_QUEUE_IN_BARRIER +</span><br><span class="line">                            dq-&gt;dq_width * DISPATCH_QUEUE_WIDTH_INTERVAL;</span><br><span class="line">                    <span class="keyword">size_t</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    dispatch_assert(dx_metatype(dq) == _DISPATCH_QUEUE_TYPE);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (dq-&gt;dq_items_tail &amp;&amp; !DISPATCH_QUEUE_IS_SUSPENDED(dq)) &#123;</span><br><span class="line">                        dc = _dispatch_queue_head(dq);</span><br><span class="line">                        <span class="keyword">if</span> (!_dispatch_object_is_sync_waiter(dc)) &#123;</span><br><span class="line">                            <span class="comment">// not a slow item, needs to wake up</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (likely(dq-&gt;dq_width == <span class="number">1</span>) ||</span><br><span class="line">                                _dispatch_object_is_barrier(dc)) &#123;</span><br><span class="line">                            <span class="comment">// rdar://problem/8290662 "barrier/writer lock transfer"</span></span><br><span class="line">                            dc_start = dc_end = (<span class="keyword">dispatch_continuation_t</span>)dc;</span><br><span class="line">                            owned = <span class="number">0</span>;</span><br><span class="line">                            count = <span class="number">1</span>;</span><br><span class="line">                            dc = _dispatch_queue_next(dq, dc);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// &lt;rdar://problem/10164594&gt; "reader lock transfer"</span></span><br><span class="line">                            <span class="comment">// we must not wake waiters immediately because our right</span></span><br><span class="line">                            <span class="comment">// for dequeuing is granted through holding the full "barrier" width</span></span><br><span class="line">                            <span class="comment">// which a signaled work item could relinquish out from our feet</span></span><br><span class="line">                            dc_start = (<span class="keyword">dispatch_continuation_t</span>)dc;</span><br><span class="line">                            <span class="keyword">do</span> &#123;</span><br><span class="line">                                <span class="comment">// no check on width here because concurrent queues</span></span><br><span class="line">                                <span class="comment">// do not respect width for blocked readers, the thread</span></span><br><span class="line">                                <span class="comment">// is already spent anyway</span></span><br><span class="line">                                dc_end = (<span class="keyword">dispatch_continuation_t</span>)dc;</span><br><span class="line">                                owned -= DISPATCH_QUEUE_WIDTH_INTERVAL;</span><br><span class="line">                                count++;</span><br><span class="line">                                dc = _dispatch_queue_next(dq, dc);</span><br><span class="line">                            &#125; <span class="keyword">while</span> (dc &amp;&amp; _dispatch_object_is_sync_waiter_non_barrier(dc));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (count) &#123;</span><br><span class="line">                            <span class="keyword">do</span> &#123;</span><br><span class="line">                                dc_tmp = dc_start;</span><br><span class="line">                                dc_start = dc_start-&gt;do_next;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">/* 通过 event loop 执行每一个dispatch_continuation_t */</span></span><br><span class="line"></span><br><span class="line">                                _dispatch_sync_waiter_redirect_or_wake(dq, owned, dc_tmp);</span><br><span class="line">                                owned = DISPATCH_SYNC_WAITER_NO_UNLOCK;</span><br><span class="line">                            &#125; <span class="keyword">while</span> (dc_tmp != dc_end);</span><br><span class="line">                            <span class="keyword">if</span> (flags &amp; DISPATCH_WAKEUP_CONSUME_2) &#123;</span><br><span class="line">                                <span class="keyword">return</span> _dispatch_release_2_tailcall(dq);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (!(flags &amp; DISPATCH_WAKEUP_CONSUME_2)) &#123;</span><br><span class="line">                            _dispatch_retain_2(dq);</span><br><span class="line">                            flags |= DISPATCH_WAKEUP_CONSUME_2;</span><br><span class="line">                        &#125;</span><br><span class="line">                        target = DISPATCH_QUEUE_WAKEUP_TARGET;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> _dispatch_queue_class_barrier_complete(dq, qos, flags, target,owned);</span><br><span class="line">        &#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (_dispatch_queue_class_probe(dq)) &#123;</span><br><span class="line">		target = DISPATCH_QUEUE_WAKEUP_TARGET;</span><br><span class="line">	&#125;</span><br><span class="line">        <span class="comment">// 内部通过_dispatch_ktrace1方法实现</span></span><br><span class="line">	<span class="keyword">return</span> _dispatch_queue_class_wakeup(dq, qos, flags, target);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="dispatch-async"><a href="#dispatch-async" class="headerlink" title="dispatch async"></a>dispatch async</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_async</span><span class="params">(<span class="keyword">dispatch_queue_t</span> dq, <span class="keyword">dispatch_block_t</span> work)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">dispatch_continuation_t</span> dc = _dispatch_continuation_alloc();</span><br><span class="line">	<span class="keyword">uintptr_t</span> dc_flags = DISPATCH_OBJ_CONSUME_BIT;</span><br><span class="line"></span><br><span class="line">	_dispatch_continuation_init(dc, dq, work, <span class="number">0</span>, <span class="number">0</span>, dc_flags) = &#123;</span><br><span class="line">        dc-&gt;dc_flags = dc_flags | DISPATCH_OBJ_BLOCK_BIT;</span><br><span class="line">        dc-&gt;dc_ctxt = _dispatch_Block_copy(work);</span><br><span class="line">        _dispatch_continuation_priority_set(dc, pp, flags);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (unlikely(_dispatch_block_has_private_data(work))) &#123;</span><br><span class="line">            <span class="comment">// always sets dc_func &amp; dc_voucher</span></span><br><span class="line">            <span class="comment">// may update dc_priority &amp; do_vtable</span></span><br><span class="line">            <span class="keyword">return</span> _dispatch_continuation_init_slow(dc, dqu, flags);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dc_flags &amp; DISPATCH_OBJ_CONSUME_BIT) &#123;</span><br><span class="line">            <span class="comment">//设置dc_func为work的执行并追加对象释放代码的函数</span></span><br><span class="line">            dc-&gt;dc_func = _dispatch_call_block_and_release;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dc-&gt;dc_func = _dispatch_Block_invoke(work);</span><br><span class="line">        &#125;</span><br><span class="line">        _dispatch_continuation_voucher_set(dc, dqu, flags);</span><br><span class="line">    &#125;;</span><br><span class="line">	_dispatch_continuation_async(dq, dc) = &#123;</span><br><span class="line">        _dispatch_continuation_async2(dq, dc,</span><br><span class="line">			dc-&gt;dc_flags &amp; DISPATCH_OBJ_BARRIER_BIT) = &#123;</span><br><span class="line">                <span class="keyword">if</span> (fastpath(barrier || !DISPATCH_QUEUE_USES_REDIRECTION(dq-&gt;dq_width))) &#123;</span><br><span class="line">                    <span class="comment">// 如果是barrier async或都width为1,加到并行队列中</span></span><br><span class="line">                    <span class="keyword">return</span> _dispatch_continuation_push(dq, dc);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _dispatch_async_f2(dq, dc) = &#123;</span><br><span class="line">                    <span class="comment">// 加到并行队列</span></span><br><span class="line">                    <span class="keyword">if</span> (slowpath(dq-&gt;dq_items_tail)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> _dispatch_continuation_push(dq, dc);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (slowpath(!_dispatch_queue_try_acquire_async(dq))) &#123;</span><br><span class="line">                        <span class="keyword">return</span> _dispatch_continuation_push(dq, dc);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 根据优先级调度线程运行</span></span><br><span class="line">                    <span class="keyword">return</span> _dispatch_async_f_redirect(dq, dc,</span><br><span class="line">                            _dispatch_continuation_override_qos(dq, dc));</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dispatch_barrier_async 比 dispatch_async 的 dc_flags 多加了 DISPATCH_OBJ_BARRIER_BIT 位</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_barrier_async</span><span class="params">(<span class="keyword">dispatch_queue_t</span> dq, <span class="keyword">dispatch_block_t</span> work)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">dispatch_continuation_t</span> dc = _dispatch_continuation_alloc();</span><br><span class="line">	<span class="keyword">uintptr_t</span> dc_flags = DISPATCH_OBJ_CONSUME_BIT | DISPATCH_OBJ_BARRIER_BIT;</span><br><span class="line"></span><br><span class="line">	_dispatch_continuation_init(dc, dq, work, <span class="number">0</span>, <span class="number">0</span>, dc_flags);</span><br><span class="line">	_dispatch_continuation_push(dq, dc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatch-semaphore"><a href="#dispatch-semaphore" class="headerlink" title="dispatch semaphore"></a>dispatch semaphore</h3><p>是对UNIX底层sem的封装</p>
<h4 id="create"><a href="#create" class="headerlink" title="create"></a>create</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_semaphore_t</span> dispatch_semaphore_create(<span class="keyword">long</span> value) &#123;</span><br><span class="line">	<span class="keyword">dispatch_semaphore_t</span> dsema;</span><br><span class="line">        <span class="comment">// value值必须是自然数，也表示等待的线程数</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (value &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> DISPATCH_BAD_INPUT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建dispatch_semaphore_t</span></span><br><span class="line"></span><br><span class="line">	dsema = (<span class="keyword">dispatch_semaphore_t</span>)_dispatch_object_alloc(</span><br><span class="line">			DISPATCH_VTABLE(semaphore), <span class="keyword">sizeof</span>(struct dispatch_semaphore_s)) = &#123;</span><br><span class="line">                <span class="keyword">return</span> _os_object_alloc_realized(vtable, size) = &#123;</span><br><span class="line">                    <span class="keyword">return</span> _os_objc_alloc(cls, size) = &#123;</span><br><span class="line">                        id obj;</span><br><span class="line">                        size -= <span class="keyword">sizeof</span>(((struct _os_object_s *)<span class="literal">NULL</span>)-&gt;os_obj_isa);</span><br><span class="line">                        <span class="keyword">while</span> (!fastpath(obj = class_createInstance(cls, size))) &#123;</span><br><span class="line">                            _dispatch_temporary_resource_shortage();</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> obj;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;;</span><br><span class="line">	_dispatch_semaphore_class_init(value, dsema) = &#123;</span><br><span class="line">            struct dispatch_semaphore_header_s *dsema = dsemau._dsema_hdr;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行的tq是从root queue中取得的 label 是 com.apple.root.default-qos 的 queue</span></span><br><span class="line">            <span class="comment">// 初始化_dispatch_sema4_t</span></span><br><span class="line">            dsema-&gt;do_next = DISPATCH_OBJECT_LISTLESS;</span><br><span class="line">            dsema-&gt;do_targetq = _dispatch_get_root_queue(DISPATCH_QOS_DEFAULT, <span class="literal">false</span>);</span><br><span class="line">            dsema-&gt;dsema_value = value;</span><br><span class="line">            _dispatch_sema4_init(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">    &#125;;</span><br><span class="line">	dsema-&gt;dsema_orig = value;</span><br><span class="line">	<span class="keyword">return</span> dsema;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">dispatch_semaphore_wait</span><span class="params">(<span class="keyword">dispatch_semaphore_t</span> dsema, <span class="keyword">dispatch_time_t</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 信号量减少，若小于0则等待</span></span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_dec2o(dsema, dsema_value, acquire);</span><br><span class="line">	<span class="keyword">if</span> (fastpath(value &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_wait_slow(dsema, timeout) = &#123;</span><br><span class="line">            <span class="keyword">long</span> orig;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             初始化_dispatch_sema4_t</span></span><br><span class="line"><span class="comment">             根据timeout进行不同的处理：</span></span><br><span class="line"><span class="comment">             1. 时间到了，超时，解除锁定</span></span><br><span class="line"><span class="comment">             2. 时间未到，调用UNIX底层函数等待</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            _dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">            <span class="keyword">switch</span> (timeout) &#123;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">if</span> (!_dispatch_sema4_timedwait(&amp;dsema-&gt;dsema_sema, timeout)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Fall through and try to undo what the fast path did to</span></span><br><span class="line">                <span class="comment">// dsema-&gt;dsema_value</span></span><br><span class="line">            <span class="keyword">case</span> DISPATCH_TIME_NOW:</span><br><span class="line">                orig = dsema-&gt;dsema_value;</span><br><span class="line">                <span class="keyword">while</span> (orig &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (os_atomic_cmpxchgvw2o(dsema, dsema_value, orig, orig + <span class="number">1</span>,</span><br><span class="line">                            &amp;orig, relaxed)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> _DSEMA4_TIMEOUT();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Another thread called semaphore_signal().</span></span><br><span class="line">                <span class="comment">// Fall through and drain the wakeup.</span></span><br><span class="line">            <span class="keyword">case</span> DISPATCH_TIME_FOREVER:</span><br><span class="line">                _dispatch_sema4_wait(&amp;dsema-&gt;dsema_sema) = &#123;</span><br><span class="line">                    <span class="keyword">int</span> ret = sem_wait(sema);</span><br><span class="line">	                DISPATCH_SEMAPHORE_VERIFY_RET(ret);</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">dispatch_semaphore_signal</span><span class="params">(<span class="keyword">dispatch_semaphore_t</span> dsema)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 信号量加1，若大于0，则无需处理</span></span><br><span class="line">    <span class="comment">// 反之则调用UNIX底层sem_post</span></span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_inc2o(dsema, dsema_value, release);</span><br><span class="line">	<span class="keyword">if</span> (fastpath(value &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (slowpath(value == LONG_MIN)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">				<span class="string">"Unbalanced call to dispatch_semaphore_signal()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_semaphore_signal_slow(dsema) = &#123;</span><br><span class="line">            _dispatch_sema4_create(&amp;dsema-&gt;dsema_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">            _dispatch_sema4_signal(&amp;dsema-&gt;dsema_sema, <span class="number">1</span>) = &#123;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    <span class="keyword">int</span> ret = sem_post(sema);</span><br><span class="line">                    DISPATCH_SEMAPHORE_VERIFY_RET(ret);</span><br><span class="line">                &#125; <span class="keyword">while</span> (--count);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatch-group"><a href="#dispatch-group" class="headerlink" title="dispatch group"></a>dispatch group</h3><p>dispatch group依靠dispatch semaphore来工作的</p>
<h4 id="create-1"><a href="#create-1" class="headerlink" title="create"></a>create</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_group_t</span> dispatch_group_create(<span class="keyword">void</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_group_create_with_count(<span class="number">0</span>) = &#123;</span><br><span class="line">            <span class="comment">// 创建 dispatch_group_t 并绑定一个 dispatch_semaphore_t</span></span><br><span class="line">            <span class="keyword">dispatch_group_t</span> dg = (<span class="keyword">dispatch_group_t</span>)_dispatch_object_alloc(</span><br><span class="line">                DISPATCH_VTABLE(group), <span class="keyword">sizeof</span>(struct dispatch_group_s));</span><br><span class="line">            _dispatch_semaphore_class_init(count, dg);</span><br><span class="line">            <span class="keyword">if</span> (count) &#123;</span><br><span class="line">                os_atomic_store2o(dg, do_ref_cnt, <span class="number">1</span>, relaxed); <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> dg;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="group-async"><a href="#group-async" class="headerlink" title="group async"></a>group async</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_group_async</span><span class="params">(<span class="keyword">dispatch_group_t</span> dg, <span class="keyword">dispatch_queue_t</span> dq,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">dispatch_block_t</span> db)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">dispatch_continuation_t</span> dc = _dispatch_continuation_alloc();</span><br><span class="line">	<span class="keyword">uintptr_t</span> dc_flags = DISPATCH_OBJ_CONSUME_BIT | DISPATCH_OBJ_GROUP_BIT;</span><br><span class="line"></span><br><span class="line">	_dispatch_continuation_init(dc, dq, db, <span class="number">0</span>, <span class="number">0</span>, dc_flags);</span><br><span class="line">	_dispatch_continuation_group_async(dg, dq, dc) = &#123;</span><br><span class="line">            dispatch_group_enter(dg);</span><br><span class="line">            dc-&gt;dc_data = dg;</span><br><span class="line">            _dispatch_continuation_async(dq, dc); <span class="comment">//同dispatch_async</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只是待处理事项数加1</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_group_enter</span><span class="params">(<span class="keyword">dispatch_group_t</span> dg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_inc_orig2o(dg, dg_value, acquire);</span><br><span class="line">	<span class="keyword">if</span> (slowpath((<span class="keyword">unsigned</span> <span class="keyword">long</span>)value &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)LONG_MAX)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">				<span class="string">"Too many nested calls to dispatch_group_enter()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (value == <span class="number">0</span>) &#123;</span><br><span class="line">		_dispatch_retain(dg); <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 待处理事项数减1，唤醒group，并释放资源</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_group_leave</span><span class="params">(<span class="keyword">dispatch_group_t</span> dg)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">long</span> value = os_atomic_dec2o(dg, dg_value, release);</span><br><span class="line">	<span class="keyword">if</span> (slowpath(value == <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">void</span>)_dispatch_group_wake(dg, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (slowpath(value &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(value,</span><br><span class="line">				<span class="string">"Unbalanced call to dispatch_group_leave()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="wait-1"><a href="#wait-1" class="headerlink" title="wait"></a>wait</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">dispatch_group_wait</span><span class="params">(<span class="keyword">dispatch_group_t</span> dg, <span class="keyword">dispatch_time_t</span> timeout)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dg-&gt;dg_value == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (timeout == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> _DSEMA4_TIMEOUT();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_group_wait_slow(dg, timeout) = &#123;</span><br><span class="line">            <span class="keyword">long</span> value;</span><br><span class="line">            <span class="keyword">int</span> orig_waiters;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// check before we cause another signal to be sent by incrementing</span></span><br><span class="line">            <span class="comment">// dg-&gt;dg_waiters</span></span><br><span class="line">            value = os_atomic_load2o(dg, dg_value, ordered); <span class="comment">// 19296565</span></span><br><span class="line">            <span class="keyword">if</span> (value == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> _dispatch_group_wake(dg, <span class="literal">false</span>) = &#123;</span><br><span class="line">                    <span class="keyword">dispatch_continuation_t</span> next, head, tail = <span class="literal">NULL</span>;</span><br><span class="line">                    <span class="keyword">long</span> rval;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// cannot use os_mpsc_capture_snapshot() because we can have concurrent</span></span><br><span class="line">                    <span class="comment">// _dispatch_group_wake() calls</span></span><br><span class="line">                    head = os_atomic_xchg2o(dg, dg_notify_head, <span class="literal">NULL</span>, relaxed);</span><br><span class="line">                    <span class="keyword">if</span> (head) &#123;</span><br><span class="line">                        <span class="comment">// snapshot before anything is notified/woken &lt;rdar://problem/8554546&gt;</span></span><br><span class="line">                        tail = os_atomic_xchg2o(dg, dg_notify_tail, <span class="literal">NULL</span>, release);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 当有等待事项时，发送信号，并加到并行队列中</span></span><br><span class="line">                    rval = (<span class="keyword">long</span>)os_atomic_xchg2o(dg, dg_waiters, <span class="number">0</span>, relaxed);</span><br><span class="line">                    <span class="keyword">if</span> (rval) &#123;</span><br><span class="line">                        <span class="comment">// wake group waiters</span></span><br><span class="line">                        _dispatch_sema4_create(&amp;dg-&gt;dg_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">                        _dispatch_sema4_signal(&amp;dg-&gt;dg_sema, rval);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">uint16_t</span> refs = needs_release ? <span class="number">1</span> : <span class="number">0</span>; <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">                    <span class="keyword">if</span> (head) &#123;</span><br><span class="line">                        <span class="comment">// async group notify blocks</span></span><br><span class="line">                        <span class="keyword">do</span> &#123;</span><br><span class="line">                            next = os_mpsc_pop_snapshot_head(head, tail, do_next);</span><br><span class="line">                            <span class="keyword">dispatch_queue_t</span> dsn_queue = (<span class="keyword">dispatch_queue_t</span>)head-&gt;dc_data;</span><br><span class="line">                            _dispatch_continuation_async(dsn_queue, head);</span><br><span class="line">                            _dispatch_release(dsn_queue);</span><br><span class="line">                        &#125; <span class="keyword">while</span> ((head = next));</span><br><span class="line">                        refs++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (refs) _dispatch_release_n(dg, refs);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">            增加等待事项数</span></span><br><span class="line"><span class="comment">            当timeout超时，唤醒group里所有事项并执行</span></span><br><span class="line"><span class="comment">            否则等待信号唤醒</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            </span><br><span class="line">            (<span class="keyword">void</span>)os_atomic_inc2o(dg, dg_waiters, relaxed);</span><br><span class="line">            <span class="comment">// check the values again in case we need to wake any threads</span></span><br><span class="line">            value = os_atomic_load2o(dg, dg_value, ordered); <span class="comment">// 19296565</span></span><br><span class="line">            <span class="keyword">if</span> (value == <span class="number">0</span>) &#123;</span><br><span class="line">                _dispatch_group_wake(dg, <span class="literal">false</span>);</span><br><span class="line">                <span class="comment">// Fall through to consume the extra signal, forcing timeout to avoid</span></span><br><span class="line">                <span class="comment">// useless setups as it won't block</span></span><br><span class="line">                timeout = DISPATCH_TIME_FOREVER;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _dispatch_sema4_create(&amp;dg-&gt;dg_sema, _DSEMA4_POLICY_FIFO);</span><br><span class="line">            <span class="keyword">switch</span> (timeout) &#123;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">if</span> (!_dispatch_sema4_timedwait(&amp;dg-&gt;dg_sema, timeout)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Fall through and try to undo the earlier change to</span></span><br><span class="line">                <span class="comment">// dg-&gt;dg_waiters</span></span><br><span class="line">            <span class="keyword">case</span> DISPATCH_TIME_NOW:</span><br><span class="line">                orig_waiters = dg-&gt;dg_waiters;</span><br><span class="line">                <span class="keyword">while</span> (orig_waiters) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (os_atomic_cmpxchgvw2o(dg, dg_waiters, orig_waiters,</span><br><span class="line">                            orig_waiters - <span class="number">1</span>, &amp;orig_waiters, relaxed)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> _DSEMA4_TIMEOUT();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Another thread is running _dispatch_group_wake()</span></span><br><span class="line">                <span class="comment">// Fall through and drain the wakeup.</span></span><br><span class="line">            <span class="keyword">case</span> DISPATCH_TIME_FOREVER:</span><br><span class="line">                _dispatch_sema4_wait(&amp;dg-&gt;dg_sema);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="signal-1"><a href="#signal-1" class="headerlink" title="signal"></a>signal</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> _dispatch_group_notify(<span class="keyword">dispatch_group_t</span> dg, <span class="keyword">dispatch_queue_t</span> dq,</span><br><span class="line">		<span class="keyword">dispatch_continuation_t</span> dsn) &#123;</span><br><span class="line">        <span class="comment">//当待处理的事项数0时，唤醒group</span></span><br><span class="line">	dsn-&gt;dc_data = dq;</span><br><span class="line">	dsn-&gt;do_next = <span class="literal">NULL</span>;</span><br><span class="line">	_dispatch_retain(dq);</span><br><span class="line">	<span class="keyword">if</span> (os_mpsc_push_update_tail(dg, dg_notify, dsn, do_next)) &#123;</span><br><span class="line">		_dispatch_retain(dg);</span><br><span class="line">		os_atomic_store2o(dg, dg_notify_head, dsn, ordered);</span><br><span class="line">		<span class="comment">// seq_cst with atomic store to notify_head &lt;rdar://problem/11750916&gt;</span></span><br><span class="line">		<span class="keyword">if</span> (os_atomic_load2o(dg, dg_value, ordered) == <span class="number">0</span>) &#123;</span><br><span class="line">			_dispatch_group_wake(dg, <span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatch-once"><a href="#dispatch-once" class="headerlink" title="dispatch once"></a>dispatch once</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_once</span><span class="params">(<span class="keyword">dispatch_once_t</span> *val, <span class="keyword">dispatch_block_t</span> block)</span> </span>&#123;</span><br><span class="line">	dispatch_once_f(val, block, _dispatch_Block_invoke(block)) = &#123;</span><br><span class="line">            <span class="comment">// 首次会执行下面的dispatch_once_f，再次进入则不再处理</span></span><br><span class="line">            <span class="keyword">if</span> (DISPATCH_EXPECT(*predicate, ~<span class="number">0l</span>) != ~<span class="number">0l</span>) &#123;</span><br><span class="line">                dispatch_once_f(predicate, context, function);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dispatch_compiler_barrier();</span><br><span class="line">            &#125;</span><br><span class="line">            DISPATCH_COMPILER_CAN_ASSUME(*predicate == ~<span class="number">0l</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatch-source"><a href="#dispatch-source" class="headerlink" title="dispatch source"></a>dispatch source</h3><p>常见的例子如下，使用 GCD Timer 的好处在于不依赖 runloop<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);  </span><br><span class="line">dispatch_source_set_timer(timer, dispatch_walltime(<span class="literal">NULL</span>, <span class="number">0</span>), <span class="number">10</span>*<span class="built_in">NSEC_PER_SEC</span>, <span class="number">1</span>*<span class="built_in">NSEC_PER_SEC</span>); <span class="comment">//每10秒触发timer，误差1秒  </span></span><br><span class="line">dispatch_source_set_event_handler(timer, ^&#123;  </span><br><span class="line">    <span class="comment">// 定时器触发时执行的 block</span></span><br><span class="line">&#125;);</span><br><span class="line">dispatch_resume(timer);</span><br></pre></td></tr></table></figure></p>
<h4 id="create-2"><a href="#create-2" class="headerlink" title="create"></a>create</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dispatch_source_t</span> dispatch_source_create(<span class="keyword">dispatch_source_type_t</span> dst, <span class="keyword">uintptr_t</span> handle,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> mask, <span class="keyword">dispatch_queue_t</span> dq) &#123;</span><br><span class="line">	<span class="keyword">dispatch_source_refs_t</span> dr;</span><br><span class="line">	<span class="keyword">dispatch_source_t</span> ds;</span><br><span class="line"></span><br><span class="line">	dr = dux_create(dst, handle, mask)._dr;</span><br><span class="line">	<span class="keyword">if</span> (unlikely(!dr)) &#123;</span><br><span class="line">		<span class="keyword">return</span> DISPATCH_BAD_INPUT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ds = _dispatch_object_alloc(DISPATCH_VTABLE(source),</span><br><span class="line">			<span class="keyword">sizeof</span>(struct dispatch_source_s));</span><br><span class="line">	<span class="comment">// Initialize as a queue first, then override some settings below.</span></span><br><span class="line">	_dispatch_queue_init(ds-&gt;_as_dq, DQF_LEGACY, <span class="number">1</span>,</span><br><span class="line">			DISPATCH_QUEUE_INACTIVE | DISPATCH_QUEUE_ROLE_INNER);</span><br><span class="line">	ds-&gt;dq_label = <span class="string">"source"</span>;</span><br><span class="line">	ds-&gt;do_ref_cnt++; <span class="comment">// 管理线程的引用数加1</span></span><br><span class="line">	ds-&gt;ds_refs = dr;</span><br><span class="line">	dr-&gt;du_owner_wref = _dispatch_ptr2wref(ds);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (slowpath(!dq)) &#123;</span><br><span class="line">		dq = _dispatch_get_root_queue(DISPATCH_QOS_DEFAULT, <span class="literal">true</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		_dispatch_retain((<span class="keyword">dispatch_queue_t</span> _Nonnull)dq);</span><br><span class="line">	&#125;</span><br><span class="line">	ds-&gt;do_targetq = dq;</span><br><span class="line">	<span class="keyword">if</span> (dr-&gt;du_is_timer &amp;&amp; (dr-&gt;du_fflags &amp; DISPATCH_TIMER_INTERVAL)) &#123;</span><br><span class="line">		_dispatch_source_set_interval(ds, handle) = &#123;</span><br><span class="line">                    #define NSEC_PER_FRAME (NSEC_PER_SEC/<span class="number">60</span>)</span><br><span class="line">                    <span class="comment">// approx 1 year (60s * 60m * 24h * 365d)</span></span><br><span class="line">                    #define FOREVER_NSEC <span class="number">31536000000000000u</span>ll</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">dispatch_timer_source_refs_t</span> dr = ds-&gt;ds_timer_refs;</span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">bool</span> animation = dr-&gt;du_fflags &amp; DISPATCH_INTERVAL_UI_ANIMATION;</span><br><span class="line">                    <span class="keyword">if</span> (fastpath(interval &lt;= (animation ? FOREVER_NSEC/NSEC_PER_FRAME :</span><br><span class="line">                            FOREVER_NSEC/NSEC_PER_MSEC))) &#123;</span><br><span class="line">                        interval *= animation ? NSEC_PER_FRAME : NSEC_PER_MSEC;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        interval = FOREVER_NSEC;</span><br><span class="line">                    &#125;</span><br><span class="line">                    interval = _dispatch_time_nano2mach(interval);</span><br><span class="line">                    <span class="keyword">uint64_t</span> target = _dispatch_absolute_time() + interval;</span><br><span class="line">                    target -= (target % interval);</span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">uint64_t</span> leeway = animation ?</span><br><span class="line">                            _dispatch_time_nano2mach(NSEC_PER_FRAME) : interval / <span class="number">2</span>;</span><br><span class="line">                    dr-&gt;dt_timer.target = target;</span><br><span class="line">                    dr-&gt;dt_timer.deadline = target + leeway;</span><br><span class="line">                    dr-&gt;dt_timer.interval = interval;</span><br><span class="line">                    _dispatch_source_timer_telemetry(ds, DISPATCH_CLOCK_MACH, &amp;dr-&gt;dt_timer) = &#123;</span><br><span class="line">                        <span class="keyword">if</span> (_dispatch_trace_timer_configure_enabled() ||</span><br><span class="line">			_dispatch_source_timer_telemetry_enabled()) &#123;</span><br><span class="line">                            _dispatch_source_timer_telemetry_slow(ds, clock, values) = &#123;</span><br><span class="line">                                <span class="keyword">if</span> (_dispatch_trace_timer_configure_enabled()) &#123;</span><br><span class="line">                                    _dispatch_trace_timer_configure(ds, clock, values) = &#123;</span><br><span class="line">                                            <span class="keyword">dispatch_timer_source_refs_t</span> dr = ds-&gt;ds_timer_refs;</span><br><span class="line">                                            <span class="class"><span class="keyword">struct</span> <span class="title">dispatch_trace_timer_params_s</span> <span class="title">params</span>;</span></span><br><span class="line">                                            DISPATCH_TIMER_CONFIGURE(ds, _dispatch_trace_timer_function(dr),</span><br><span class="line">                                                    _dispatch_trace_timer_params(clock, values, <span class="number">0</span>, &amp;params));</span><br><span class="line">                                    &#125;;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;;</span><br><span class="line">                            <span class="keyword">asm</span>(<span class="string">""</span>); <span class="comment">// prevent tailcall</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	_dispatch_object_debug(ds, <span class="string">"%s"</span>, __func__);</span><br><span class="line">	<span class="keyword">return</span> ds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="set-timer"><a href="#set-timer" class="headerlink" title="set timer"></a>set timer</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_source_set_timer</span><span class="params">(<span class="keyword">dispatch_source_t</span> ds, <span class="keyword">dispatch_time_t</span> start,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">uint64_t</span> interval, <span class="keyword">uint64_t</span> leeway)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">dispatch_timer_source_refs_t</span> dt = ds-&gt;ds_timer_refs;</span><br><span class="line">	<span class="keyword">dispatch_timer_config_t</span> dtc;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!dt-&gt;du_is_timer || (dt-&gt;du_fflags&amp;DISPATCH_TIMER_INTERVAL))) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(ds, <span class="string">"Attempt to set timer on a non-timer source"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 设置开始时间，时间间隔和结束时间</span></span><br><span class="line">	dtc = _dispatch_source_timer_config_create(start, interval, leeway) = &#123;</span><br><span class="line">            <span class="keyword">dispatch_timer_config_t</span> dtc;</span><br><span class="line">            dtc = _dispatch_calloc(<span class="number">1u</span>l, <span class="keyword">sizeof</span>(struct dispatch_timer_config_s));</span><br><span class="line">            <span class="keyword">if</span> (unlikely(interval == <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (start != DISPATCH_TIME_FOREVER) &#123;</span><br><span class="line">                    _dispatch_bug_deprecated(<span class="string">"Setting timer interval to 0 requests "</span></span><br><span class="line">                            <span class="string">"a 1ns timer, did you mean FOREVER (a one-shot timer)?"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                interval = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">int64_t</span>)interval &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 6866347 - make sure nanoseconds won't overflow</span></span><br><span class="line">                interval = INT64_MAX;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">int64_t</span>)leeway &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                leeway = INT64_MAX;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (start == DISPATCH_TIME_NOW) &#123;</span><br><span class="line">                start = _dispatch_absolute_time();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (start == DISPATCH_TIME_FOREVER) &#123;</span><br><span class="line">                start = INT64_MAX;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="keyword">int64_t</span>)start &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// wall clock</span></span><br><span class="line">                start = (<span class="keyword">dispatch_time_t</span>)-((<span class="keyword">int64_t</span>)start);</span><br><span class="line">                dtc-&gt;dtc_clock = DISPATCH_CLOCK_WALL;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// absolute clock</span></span><br><span class="line">                interval = _dispatch_time_nano2mach(interval);</span><br><span class="line">                <span class="keyword">if</span> (interval &lt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="comment">// rdar://problem/7287561 interval must be at least one in</span></span><br><span class="line">                    <span class="comment">// in order to avoid later division by zero when calculating</span></span><br><span class="line">                    <span class="comment">// the missed interval count. (<span class="doctag">NOTE:</span> the wall clock's</span></span><br><span class="line">                    <span class="comment">// interval is already "fixed" to be 1 or more)</span></span><br><span class="line">                    interval = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                leeway = _dispatch_time_nano2mach(leeway);</span><br><span class="line">                dtc-&gt;dtc_clock = DISPATCH_CLOCK_MACH;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (interval &lt; INT64_MAX &amp;&amp; leeway &gt; interval / <span class="number">2</span>) &#123;</span><br><span class="line">                leeway = interval / <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            dtc-&gt;dtc_timer.target = start;</span><br><span class="line">            dtc-&gt;dtc_timer.interval = interval;</span><br><span class="line">            <span class="keyword">if</span> (start + leeway &lt; INT64_MAX) &#123;</span><br><span class="line">                dtc-&gt;dtc_timer.deadline = start + leeway;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dtc-&gt;dtc_timer.deadline = INT64_MAX;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> dtc;</span><br><span class="line">        &#125;;</span><br><span class="line">	_dispatch_source_timer_telemetry(ds, dtc-&gt;dtc_clock, &amp;dtc-&gt;dtc_timer);</span><br><span class="line">	dtc = os_atomic_xchg2o(dt, dt_pending_config, dtc, release);</span><br><span class="line">	<span class="keyword">if</span> (dtc) <span class="built_in">free</span>(dtc);</span><br><span class="line">	dx_wakeup(ds, <span class="number">0</span>, DISPATCH_WAKEUP_MAKE_DIRTY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="set-event-handler"><a href="#set-event-handler" class="headerlink" title="set event handler"></a>set event handler</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dispatch_source_set_event_handler</span><span class="params">(<span class="keyword">dispatch_source_t</span> ds,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">dispatch_block_t</span> handler)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">dispatch_continuation_t</span> dc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建dispatch_continuation_t，并加入到并行队列</span></span><br><span class="line">	dc = _dispatch_source_handler_alloc(ds, handler, DS_EVENT_HANDLER, <span class="literal">true</span>) = &#123;</span><br><span class="line">            <span class="comment">// sources don't propagate priority by default</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">dispatch_block_flags_t</span> flags =</span><br><span class="line">                    DISPATCH_BLOCK_HAS_PRIORITY | DISPATCH_BLOCK_NO_VOUCHER;</span><br><span class="line">            <span class="keyword">dispatch_continuation_t</span> dc = _dispatch_continuation_alloc();</span><br><span class="line">            <span class="keyword">if</span> (func) &#123;</span><br><span class="line">                <span class="keyword">uintptr_t</span> dc_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (kind != DS_EVENT_HANDLER) &#123;</span><br><span class="line">                    dc_flags |= DISPATCH_OBJ_CONSUME_BIT;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">ifdef</span> __BLOCKS__</span></span><br><span class="line">                    _dispatch_continuation_init(dc, ds, func, <span class="number">0</span>, flags, dc_flags);</span><br><span class="line">        <span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __BLOCKS__ */</span></span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    dc_flags |= DISPATCH_OBJ_CTXT_FETCH_BIT;</span><br><span class="line">                    _dispatch_continuation_init_f(dc, ds, ds-&gt;do_ctxt, func,</span><br><span class="line">                            <span class="number">0</span>, flags, dc_flags);</span><br><span class="line">                &#125;</span><br><span class="line">                _dispatch_trace_continuation_push(ds-&gt;_as_dq, dc);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                dc-&gt;dc_flags = <span class="number">0</span>;</span><br><span class="line">                dc-&gt;dc_func = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> dc;</span><br><span class="line">    &#125;;</span><br><span class="line">	_dispatch_source_set_handler(ds, DS_EVENT_HANDLER, dc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的细节没有找到，没有搞明白source是怎么实现的</p>

      
    </div>
    
    
    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
      
    </div>

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Richie Zhang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://blog.msrily.com/2018/09/12/blog21/" title="GCD 队列探索">https://blog.msrily.com/2018/09/12/blog21/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/28/blog20/" rel="next" title="iOS 架构">
                <i class="fa fa-chevron-left"></i> iOS 架构
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/29/blog22/" rel="prev" title="React Native 实现原理">
                React Native 实现原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="Richie Zhang" />
            
              <p class="site-author-name" itemprop="name">Richie Zhang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:lylaut@163.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-object-t"><span class="nav-number">1.</span> <span class="nav-text">dispatch_object_t</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#os-object-s"><span class="nav-number">1.1.</span> <span class="nav-text">_os_object_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-object-s"><span class="nav-number">1.2.</span> <span class="nav-text">dispatch_object_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-continuation-s"><span class="nav-number">1.3.</span> <span class="nav-text">dispatch_continuation_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-queue-s"><span class="nav-number">1.4.</span> <span class="nav-text">dispatch_queue_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-queue-attr-s"><span class="nav-number">1.5.</span> <span class="nav-text">dispatch_queue_attr_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-group-s"><span class="nav-number">1.6.</span> <span class="nav-text">dispatch_group_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-source-s"><span class="nav-number">1.7.</span> <span class="nav-text">dispatch_source_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-semaphore-s"><span class="nav-number">1.8.</span> <span class="nav-text">dispatch_semaphore_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-data-s"><span class="nav-number">1.9.</span> <span class="nav-text">dispatch_data_s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-sync-context-s"><span class="nav-number">1.10.</span> <span class="nav-text">dispatch_sync_context_s</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-queue"><span class="nav-number">2.</span> <span class="nav-text">dispatch queue</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#获取queue"><span class="nav-number">2.1.</span> <span class="nav-text">获取queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#main-mgr-root-queue-init"><span class="nav-number">2.2.</span> <span class="nav-text">main/mgr/root queue init</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#global-queue"><span class="nav-number">2.3.</span> <span class="nav-text">global queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#main-queue"><span class="nav-number">2.4.</span> <span class="nav-text">main queue</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#user-queue"><span class="nav-number">2.5.</span> <span class="nav-text">user queue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-sync-async"><span class="nav-number">3.</span> <span class="nav-text">dispatch sync/async</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-sync"><span class="nav-number">3.1.</span> <span class="nav-text">dispatch sync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-async"><span class="nav-number">3.2.</span> <span class="nav-text">dispatch async</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-semaphore"><span class="nav-number">4.</span> <span class="nav-text">dispatch semaphore</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#create"><span class="nav-number">4.1.</span> <span class="nav-text">create</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wait"><span class="nav-number">4.2.</span> <span class="nav-text">wait</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#signal"><span class="nav-number">4.3.</span> <span class="nav-text">signal</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-group"><span class="nav-number">5.</span> <span class="nav-text">dispatch group</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#create-1"><span class="nav-number">5.1.</span> <span class="nav-text">create</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#group-async"><span class="nav-number">5.2.</span> <span class="nav-text">group async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#wait-1"><span class="nav-number">5.3.</span> <span class="nav-text">wait</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#signal-1"><span class="nav-number">5.4.</span> <span class="nav-text">signal</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-once"><span class="nav-number">6.</span> <span class="nav-text">dispatch once</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch-source"><span class="nav-number">7.</span> <span class="nav-text">dispatch source</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#create-2"><span class="nav-number">7.1.</span> <span class="nav-text">create</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set-timer"><span class="nav-number">7.2.</span> <span class="nav-text">set timer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set-event-handler"><span class="nav-number">7.3.</span> <span class="nav-text">set event handler</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Richie Zhang</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
